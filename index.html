<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>شكلمة - Shkalma Sweets</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            /* Purple Theme - Shkalma */
            --primary-color: #6A1B9A; 
            --primary-light: #4A148C;
            --secondary-color: #9C27B0;
            --accent-color: #AB47BC;
            --background: #FEFCFF;
            --surface: #ffffff;
            --text-primary: #333;
            --text-secondary: #666;
            --border-color: #E1BEE7;
            --success: #2e7d32;
            --warning: #f9a825;
            --error: #c62828;
            --blue-cost: #1565c0;
            --shadow-sm: 0 4px 12px rgba(106, 27, 154, 0.08);
            --gap-size: 1.5rem;
            
            /* Dynamic Currency Variable */
            --currency-symbol: "د.ب";
        }
        * { box-sizing: border-box; }
        body { font-family: 'IBM Plex Sans Arabic', sans-serif; background-color: var(--background); color: var(--text-primary); line-height: 1.6; margin: 0; padding: 0; }
        
        /* Sidebar */
        .sidebar { background: linear-gradient(180deg, var(--primary-color) 0%, var(--primary-light) 100%); min-height: 100vh; color: white; position: fixed; top: 0; right: 0; width: 260px; z-index: 1000; overflow-y: auto; transition: transform 0.3s ease; box-shadow: -4px 0 15px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        .sidebar-header { padding: 3rem 1rem 2rem; text-align: center; background: rgba(0,0,0,0.1); }
        .sidebar-title { font-size: 1.6rem; font-weight: 700; color: #fff; line-height: 1.2; margin-bottom: 5px; }
        .sidebar-subtitle { font-size: 0.95rem; font-weight: 300; opacity: 0.9; letter-spacing: 1px; }
        .sidebar-nav { flex-grow: 1; margin-top: 1rem; }
        .sidebar .nav-link { color: rgba(255,255,255,0.85); padding: 0.9rem 1.2rem; margin: 0.4rem 0.8rem; border-radius: 12px; display: flex; align-items: center; gap: 0.8rem; font-weight: 500; text-decoration: none; cursor: pointer; transition: 0.2s; }
        .sidebar .nav-link:hover, .sidebar .nav-link.active { background: rgba(255,255,255,0.15); color: #fff; transform: translateX(-5px); backdrop-filter: blur(5px); }
        .sidebar-footer-logo { padding: 30px 20px; text-align: center; margin-top: auto; }
        .sidebar-footer-logo img { max-width: 120px; max-height: 120px; opacity: 0.95; filter: brightness(0) invert(1); cursor: pointer; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .sidebar-footer-logo img:hover { transform: scale(1.15); }

        /* Main Content */
        .main-content { margin-right: 260px; padding: 2rem; min-height: 100vh; }
        .page { display: none; animation: fadeIn 0.4s ease; } .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Grid Layout */
        .budget-grid-layout { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: var(--gap-size); align-items: start; }
        .area-treasury { grid-column: 1; } .area-expenses { grid-column: 2; } .area-prod { grid-column: 3; grid-row: 1 / span 2; height: 100%; }
        .area-chart { grid-column: 1; } .area-salaries { grid-column: 2; }

        /* Cards */
        .card-modern { background: var(--surface); border: 1px solid var(--border-color); border-radius: 16px; box-shadow: var(--shadow-sm); overflow: hidden; display: flex; flex-direction: column; height: 100%; margin-bottom: 0; }
        /* Uniform Spacing for all cards in calculation section */
        #view-product-calc .card-modern, #view-product-calc .row { margin-bottom: var(--gap-size); }
        
        .card-header-modern { background: #fff; padding: 1.2rem 1.5rem; font-weight: 700; font-size: 1.05rem; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; color: var(--primary-color); }
        .card-body-modern { padding: 1.5rem; flex-grow: 1; }

        /* Modified theme container to match modern card style */
        .card-theme-container { border: 1px solid var(--border-color); border-radius: 16px; overflow: hidden; margin-bottom: var(--gap-size); background: var(--surface); box-shadow: var(--shadow-sm); }
        .card-header-theme { background: #fff; color: var(--primary-color); padding: 1.2rem 1.5rem; font-weight: 700; font-size: 1.05rem; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        .card-theme-container .form-control-modern { background: #ffffff; }

        .form-control-modern, .form-select-modern { border: 1px solid #CE93D8; border-radius: 10px; padding: 0.7rem 1rem; width: 100%; }
        .form-control-modern:focus, .form-select-modern:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 3px rgba(106, 27, 154, 0.1); }
        .btn-modern { border: none; border-radius: 10px; padding: 0.5rem 1rem; font-weight: 500; cursor: pointer; transition: 0.2s; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; gap: 0.4rem; font-size: 0.9rem; }
        .btn-primary-modern { background: var(--primary-color); color: white; }
        .btn-success-modern { background: var(--success); color: white; }
        .btn-danger-modern { background: var(--error); color: white; }
        .btn-warning-modern { background: var(--warning); color: #fff; }
        .btn-info-modern { background: #0288d1; color: white; }
        .btn-secondary-modern { background: #757575; color: white; }

        .table-modern { width: 100%; border-collapse: separate; border-spacing: 0; }
        .table-modern th { background: #F3E5F5; padding: 1rem; text-align: center; font-weight: 600; color: var(--primary-color); border-bottom: 2px solid var(--border-color); }
        .table-modern td { padding: 0.9rem; text-align: center; border-bottom: 1px solid #f0f0f0; vertical-align: middle; }

        .profit-highlight { background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%); color: white; padding: 1.5rem; border-radius: 16px; text-align: center; margin-bottom: 1.5rem; box-shadow: 0 4px 15px rgba(106, 27, 154, 0.2); }
        .profit-highlight h5, .profit-highlight small, .profit-highlight h2 { color: #ffffff !important; opacity: 1 !important; }

        .report-row { display: flex; justify-content: space-between; margin-bottom: 0.8rem; font-size: 0.95rem; } .report-val { font-weight: 700; }
        .prod-item { border-bottom: 1px solid #f0f0f0; padding-bottom: 1rem; margin-bottom: 1rem; } .prod-item:last-child { border: none; margin: 0; padding: 0; }
        .prod-item-name { font-weight: bold; color: var(--primary-color); margin-bottom: 0.5rem; display: block; }
        .prod-item-stat { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 0.2rem; } .prod-item-val { font-weight: 700; color: #333; }
        
        .cost-summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .cost-card { background: white; border: 1px solid var(--border-color); border-radius: 12px; padding: 1.2rem; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .cost-card-title { font-size: 0.85rem; color: #777; margin-bottom: 0.5rem; font-weight: 500; }
        .cost-card-value { font-size: 1.3rem; font-weight: 700; color: var(--primary-color); }
        .cost-card.profit { border-color: var(--warning); } .cost-card.profit .cost-card-value { color: var(--warning); }
        .cost-card.final { border-color: var(--success); background: #e8f5e9; } .cost-card.final .cost-card-value { color: var(--success); }

        .nav-tabs-modern { border: none; gap: 8px; margin-bottom: 1.5rem; }
        .nav-tabs-modern .nav-link { border: 1px solid var(--border-color); border-radius: 20px; color: var(--text-secondary); padding: 0.6rem 1.5rem; font-weight: 500; background: white; }
        .nav-tabs-modern .nav-link.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }

        .price-input-container { position: relative; }
        .price-input-container::after { content: var(--currency-symbol); position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #999; font-size: 0.8rem; }
        .price-input-container input { padding-left: 35px; }
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
        .status-active { background: #e8f5e9; color: #2e7d32; } .status-inactive { background: #ffebee; color: #c62828; }
        .filter-wrapper { background: white; padding: 10px; border-radius: 12px; box-shadow: var(--shadow-sm); border: 1px solid var(--border-color); margin-bottom: 20px; }

        .summary-input-large { font-size: 1.5rem; font-weight: 700; text-align: center; height: 60px; background: #fff; color: #333; border: 1px solid #ddd; }
        .summary-label { font-size: 0.9rem; color: var(--primary-color); margin-bottom: 8px; font-weight: 700; display: block; text-align: center; }
        .profit-btn-display { border-radius: 8px; padding: 8px; font-weight: 600; font-size: 0.9rem; text-align: center; margin-top: 10px; border: 1px solid transparent; }
        .profit-btn-green { background: #e8f5e9; color: #2e7d32; border-color: #2e7d32; }
        .profit-btn-orange { background: #fff3e0; color: #ef6c00; border-color: #ef6c00; }
        .depreciation-note { background: #ffebee; color: #c62828; border: 1px solid #ef9a9a; border-radius: 8px; padding: 10px; text-align: center; font-weight: 600; font-size: 0.9rem; margin-top: 15px; }
        .text-blue-custom { color: #1976d2; font-weight: 700; } .text-orange-custom { color: #f57c00; font-weight: 700; }
        .save-btn-container { text-align: center; margin-top: 20px; }
        .save-btn-custom { background: #00c853; color: white; font-size: 1.1rem; padding: 10px 40px; border-radius: 8px; border: none; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; }
        .save-btn-custom:hover { background: #009624; color: white; }
        
        .total-footer { background: #f8f9fa; border-top: 2px solid #eee; padding: 10px; border-radius: 0 0 10px 10px; margin-top: 15px; text-align: center; font-weight: 700; color: var(--primary-color); }
        .total-footer small { display: block; font-weight: 500; color: #666; margin-top: 5px; }

        /* Settings Professional Design */
        .settings-card-body { padding: 2.5rem; }
        .settings-section-title { font-size: 1.1rem; font-weight: 700; color: var(--primary-color); margin-bottom: 1.2rem; border-bottom: 2px solid #f0f0f0; padding-bottom: 0.5rem; }
        .settings-input-group { margin-bottom: 1.5rem; }
        .settings-label { display: block; margin-bottom: 0.6rem; font-weight: 600; color: #444; }
        .logo-upload-wrapper { display: flex; align-items: flex-start; gap: 20px; background: #f9f9f9; padding: 20px; border-radius: 12px; border: 1px dashed var(--border-color); }
        .logo-preview-box { width: 120px; height: 120px; border-radius: 12px; background: white; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; overflow: hidden; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .logo-preview-box:hover { transform: scale(1.02); }
        .logo-preview-box img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .logo-placeholder-text { font-size: 0.8rem; color: #999; text-align: center; }
        .logo-controls { flex-grow: 1; }

        /* Modal for Logo */
        .modal-logo-img { width: 100%; height: auto; }

        @media (max-width: 992px) {
            .budget-grid-layout { grid-template-columns: 1fr; }
            .area-treasury, .area-expenses, .area-chart, .area-salaries, .area-prod { grid-column: auto; grid-row: auto; }
            .sidebar { transform: translateX(100%); } .main-content { margin-right: 0; padding: 1rem; }
            .sidebar.show { transform: translateX(0) !important; }
        }
    </style>
</head>
<body>
    <button class="btn btn-primary-modern d-md-none position-fixed" style="top:1rem;right:1rem;z-index:1001" id="sidebarToggle"><i class="bi bi-list"></i></button>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title" id="sidebar-project-name-ar">شكلمة</div>
            <div class="sidebar-subtitle" id="sidebar-project-name-en">Shkalma Sweets</div>
        </div>
        <nav class="sidebar-nav">
            <ul class="nav flex-column">
                <li class="nav-item"><a class="nav-link active" href="#dashboard" data-page="dashboard"><i class="bi bi-pie-chart-fill"></i> ملخص الميزانية</a></li>
                <li class="nav-item"><a class="nav-link" href="#product-main" data-page="product-main"><i class="bi bi-box-seam-fill"></i> المنتجات</a></li>
                <li class="nav-item"><a class="nav-link" href="#invoices-main" data-page="invoices-main"><i class="bi bi-receipt"></i> الفواتير</a></li>
                <li class="nav-item"><a class="nav-link" href="#budget-ops" data-page="budget-ops"><i class="bi bi-wallet2"></i> العمليات المالية</a></li>
                <li class="nav-item"><a class="nav-link" href="#settings-page" data-page="settings-page"><i class="bi bi-gear-fill"></i> الإعدادات</a></li>
            </ul>
        </nav>
        <div class="sidebar-footer-logo">
            <img src="https://i.imgur.com/image_f84c5f.png" alt="Footer Logo" id="sidebar-footer-img" onclick="enlargeLogo()">
        </div>
    </div>

    <div class="main-content">
        <div id="dashboard" class="page active">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="fw-bold text-primary m-0"><i class="bi bi-speedometer2"></i> ملخص الميزانية</h3>
            </div>
            <div class="filter-wrapper"><div class="row align-items-center g-2"><div class="col-auto"><i class="bi bi-filter text-primary fs-5"></i></div><div class="col-md-4"><select id="budget-month-filter" class="form-select-modern" onchange="toggleFilterInputs('budget')"></select></div><div class="col-md-7" id="budget-filter-custom-div" style="display:none;"><div class="d-flex gap-2 align-items-center"><input type="date" id="budget-filter-from" class="form-control-modern" placeholder="من"><input type="date" id="budget-filter-to" class="form-control-modern" placeholder="إلى"><button class="btn btn-primary-modern btn-sm" onclick="updateBudgetUI()">تطبيق</button></div></div></div></div>
            <div class="row mb-4 g-3">
                <div class="col-md-6"><div class="profit-highlight h-100 d-flex flex-column justify-content-center"><h5 class="mb-2">صافي الربح من المبيعات</h5><h2 class="fw-bold m-0" id="report-net-benefit">0.000</h2><small>المبيعات - تكلفة البضاعة المباعة</small></div></div>
                <div class="col-md-6"><div class="profit-highlight h-100 d-flex flex-column justify-content-center" style="background: linear-gradient(135deg, var(--secondary-color), var(--primary-light));"><h5 class="mb-2">صافي الربح بناءً على الميزانية</h5><h2 class="fw-bold m-0" id="report-net-budget">0.000</h2><small>إجمالي المبيعات - إجمالي المصروفات</small></div></div>
            </div>
            <div class="budget-grid-layout">
                <div class="card-modern area-treasury" style="border-top: 4px solid var(--success);"><div class="card-header-modern text-success"><i class="bi bi-bank"></i> الخزينة</div><div class="card-body-modern"><div class="report-row"><span>استلام (كاش)</span><span class="report-val text-success" id="rep-cash-in">0.000</span></div><div class="report-row"><span>استلام (بنفت)</span><span class="report-val text-success" id="rep-benefit-in">0.000</span></div><hr class="my-2"><div class="report-row"><span>استرداد (كاش)</span><span class="report-val text-danger" id="rep-cash-out">0.000</span></div><div class="report-row"><span>استرداد (بنفت)</span><span class="report-val text-danger" id="rep-benefit-out">0.000</span></div><hr class="my-2"><div class="report-row fw-bold text-primary"><span>المجموع</span><span class="report-val" id="rep-net">0.000</span></div><div class="report-row fw-bold mt-2 pt-2 border-top"><span>المتبقي</span><div class="text-end"><div class="small">كاش: <span id="rem-cash">0.000</span></div><div class="small">بنفت: <span id="rem-benefit">0.000</span></div><div class="text-success" id="rep-final-remainder">الإجمالي: 0.000</div></div></div></div></div>
                <div class="card-modern area-expenses" style="border-top: 4px solid var(--error);"><div class="card-header-modern text-danger"><i class="bi bi-cart-dash"></i> المصروفات</div><div class="card-body-modern"><div class="report-row"><span>المشتريات</span><span class="report-val" id="rep-purchases-total">0.000</span></div><div class="report-row"><span>الرواتب</span><span class="report-val" id="rep-salaries-total">0.000</span></div><hr class="my-2"><div class="report-row fw-bold text-danger"><span>الإجمالي</span><span class="report-val" id="rep-expenses-total">0.000</span></div></div></div>
                <div class="card-modern area-prod" style="border-top: 4px solid var(--warning);"><div class="card-header-modern text-warning"><i class="bi bi-box-seam"></i> الإنتاج</div><div class="card-body-modern"><div id="production-list-container"></div><small class="text-muted d-block mt-3 text-center pt-2 border-top">* الكيلو = 2 علبة</small></div></div>
                <div class="card-modern area-chart"><div class="card-header-modern">تحليل المصروفات</div><div class="card-body-modern d-flex justify-content-center align-items-center"><div style="height: 350px; width: 100%;"><canvas id="expensesChart"></canvas></div></div></div>
                <div class="card-modern area-salaries"><div class="card-header-modern">تفاصيل الرواتب</div><ul class="list-group list-group-flush" id="rep-salary-list"></ul></div>
            </div>
        </div>

        <div id="product-main" class="page">
            <h3 class="mb-4 fw-bold text-primary">المنتجات</h3>
            <ul class="nav nav-pills nav-tabs-modern" id="productTabs">
                <li class="nav-item"><button class="nav-link active" onclick="switchProductView('list')"><i class="bi bi-list-ul"></i> قائمة المنتجات</button></li>
                <li class="nav-item"><button class="nav-link" onclick="switchProductView('calc'); clearForm();"><i class="bi bi-calculator"></i> حساب تكلفة منتج جديد</button></li>
            </ul>
            <div id="view-product-list"><div class="card-modern"><div class="card-body-modern p-0"><div class="table-responsive"><table class="table-modern" id="products-list-table"><thead><tr><th>الرمز</th><th>الاسم</th><th>التكلفة</th><th>السعر</th><th>الربح</th><th>الحالة</th><th>الإجراءات</th></tr></thead><tbody id="products-list"></tbody></table></div></div></div></div>
            <div id="view-product-calc" style="display:none;">
                <div class="cost-summary-grid">
                    <div class="cost-card"><div class="cost-card-title">مواد</div><div class="cost-card-value" id="summary-materials">0.000</div></div>
                    <div class="cost-card"><div class="cost-card-title">تغليف</div><div class="cost-card-value" id="summary-packaging">0.000</div></div>
                    <div class="cost-card"><div class="cost-card-title">عمالة</div><div class="cost-card-value" id="summary-labor">0.000</div></div>
                    <div class="cost-card"><div class="cost-card-title">إهلاك</div><div class="cost-card-value" id="summary-depreciation">0.000</div></div>
                    <div class="cost-card final"><div class="cost-card-title">بيع</div><div class="cost-card-value" id="summary-sale-price">0.000</div></div>
                    <div class="cost-card profit"><div class="cost-card-title">ربح</div><div class="cost-card-value" id="summary-profit-margin">0.000</div></div>
                </div>
                <div class="card-modern"><div class="card-header-modern">البيانات الأساسية</div><div class="card-body-modern"><div class="row g-3"><div class="col-md-4"><label class="form-label">اسم المنتج</label><input type="text" class="form-control-modern" id="product-name"></div><div class="col-md-3"><label class="form-label">القطع في العلبة</label><input type="number" class="form-control-modern" id="sale-quantity"></div><div class="col-md-2"><label class="form-label">نسبة الربح (%)</label><input type="number" class="form-control-modern" id="profit-rate"></div><div class="col-md-3"><label class="form-label">الرمز</label><input type="text" class="form-control-modern" id="product-code" readonly style="background:#f9f9f9"></div></div></div></div>
                
                <div class="row">
                    <div class="col-md-12">
                        <div class="card-modern" style="margin-bottom: var(--gap-size);">
                            <div class="card-header-modern">
                                <span>اليد العاملة</span>
                            </div>
                            <div class="card-body-modern">
                                <div class="d-flex justify-content-center align-items-center gap-3 mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="laborMethod" id="laborMethodSalary" value="salary" checked onchange="toggleLaborMethod()">
                                        <label class="form-check-label fw-bold" for="laborMethodSalary">راتب شهري</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="laborMethod" id="laborMethodWeight" value="weight" onchange="toggleLaborMethod()">
                                        <label class="form-check-label fw-bold" for="laborMethodWeight">بالوزن/القطعة</label>
                                    </div>
                                    <div class="ms-3">
                                        <select id="calc-unit-type" class="form-select-modern form-select-sm" onchange="updateCalcLabels()">
                                            <option value="علبة">علبة</option>
                                            <option value="كيلو">كيلو</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div id="labor-salary-container">
                                    <div class="row g-3">
                                        <div class="col-md-3">
                                            <label class="form-label">الراتب الشهري</label>
                                            <input type="number" class="form-control-modern salary" placeholder="مثال: 150">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">مدة العمل (ساعات)</label>
                                            <input type="number" class="form-control-modern hours" placeholder="مثال: 2">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label" id="lbl-prod-qty-salary">الكمية المنتجة (علبة)</label>
                                            <input type="number" class="form-control-modern pieces" placeholder="مثال: 50">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">تكلفة الساعة</label>
                                            <div class="form-control-modern bg-light hourly-cost fw-bold">0.000</div>
                                        </div>
                                        <div class="col-md-12 text-center mt-2">
                                            <small class="text-muted">* يتم احتساب الساعة بناءً على 30 يوم عمل و 8 ساعات يومياً (240 ساعة/شهر).</small>
                                        </div>
                                    </div>
                                </div>

                                <div id="labor-weight-container" style="display: none;">
                                    <div class="row g-3 justify-content-center">
                                        <div class="col-md-4">
                                            <label class="form-label" id="lbl-labor-cost">تكلفة العمال (لكل علبة)</label>
                                            <input type="number" class="form-control-modern" id="labor-direct-cost" placeholder="0.000">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label" id="lbl-prod-qty-weight">الكمية المنتجة (لكل علبة)</label>
                                            <input type="number" class="form-control-modern" id="labor-weight-qty" placeholder="مثال: 50">
                                        </div>
                                    </div>
                                </div>
                                <div class="depreciation-note mt-3 p-2 text-center" style="color: var(--error); border-color: var(--error); background: #ffebee;">
                                    * يرجى إدخال التفاصيل في خانات تكاليف اليد العاملة لضمان ظهور النتيجة بشكل صحيح.
                                </div>
                                <div class="total-footer mt-3">
                                    <div id="lbl-total-labor-cost-footer">إجمالي تكلفة اليد العاملة للعلبة <span id="total-labor-cost-display">0.000</span> د.ب</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card-modern h-100">
                            <div class="card-header-modern">المواد الأولية</div>
                            <div class="card-body-modern d-flex flex-column">
                                <div class="flex-grow-1">
                                    <table class="table-modern" id="materials-table">
                                        <thead><tr><th width="35%">المادة</th><th>السعر</th><th>الحجم</th><th>المستخدم</th><th>التكلفة</th><th></th></tr></thead>
                                        <tbody id="materials-tbody">
                                            <tr>
                                                <td><input class="form-control-modern material-name" placeholder="طحين"></td>
                                                <td><input type="number" class="form-control-modern material-price" step="0.001" placeholder="السعر"></td>
                                                <td><input type="number" class="form-control-modern material-count" value="1000" placeholder="جم"></td>
                                                <td><input type="number" class="form-control-modern material-used" placeholder="جم"></td>
                                                <td class="material-cost fw-bold">0.000</td>
                                                <td><button class="btn btn-danger-modern btn-sm remove-row"><i class="bi bi-trash"></i></button></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <button class="btn btn-success-modern w-100 mt-2" id="add-material"><i class="bi bi-plus"></i> إضافة مادة</button>
                                </div>
                                <div class="total-footer mt-3">
                                    <div>إجمالي تكلفة المواد الأولية <span id="total-materials-display">0.000</span> د.ب</div>
                                    <small id="lbl-mat-per-unit">إجمالي تكلفة المواد الأولية (لكل علبة) <span id="total-materials-per-unit-display">0.000</span> د.ب</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card-modern h-100">
                            <div class="card-header-modern">التغليف</div>
                            <div class="card-body-modern d-flex flex-column">
                                <div class="flex-grow-1">
                                    <table class="table-modern" id="packaging-table">
                                        <thead><tr><th width="35%">المادة</th><th>السعر</th><th>العدد</th><th>المستخدم</th><th>التكلفة</th><th></th></tr></thead>
                                        <tbody id="packaging-tbody">
                                            <tr>
                                                <td><input class="form-control-modern packaging-name" placeholder="علبة"></td>
                                                <td><input type="number" class="form-control-modern packaging-price" step="0.001" placeholder="السعر"></td>
                                                <td><input type="number" class="form-control-modern packaging-count" value="1" placeholder="العدد"></td>
                                                <td><input type="number" class="form-control-modern packaging-used" placeholder="المستخدم"></td>
                                                <td class="packaging-cost fw-bold">0.000</td>
                                                <td><button class="btn btn-danger-modern btn-sm remove-row"><i class="bi bi-trash"></i></button></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <button class="btn btn-success-modern w-100 mt-2" id="add-packaging"><i class="bi bi-plus"></i> إضافة تغليف</button>
                                </div>
                                <div class="total-footer mt-3">
                                    <div>إجمالي تكلفة التغليف <span id="total-packaging-display">0.000</span> د.ب</div>
                                    <small id="lbl-pack-per-unit">إجمالي تكلفة التغليف (لكل علبة) <span id="total-packaging-per-unit-display">0.000</span> د.ب</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card-theme-container">
                    <div class="card-header-theme"><i class="bi bi-tools"></i> إهلاك المعدات</div>
                    <div class="p-3">
                        <div class="row g-3 align-items-center">
                            <div class="col-md-4">
                                <label class="summary-label text-start">النسبة المئوية (%)</label>
                                <input type="number" class="form-control-modern text-center" id="depreciation-rate" placeholder="مثال: 10" value="10">
                            </div>
                            <div class="col-md-4 text-center">
                                <label class="summary-label">إهلاك المعدات (د.ب)</label>
                                <div class="form-control-modern fs-5" id="equipment-depreciation-total">0.000</div>
                            </div>
                            <div class="col-md-4 text-center">
                                <label class="summary-label">إهلاك المعدات للعلبة (د.ب)</label>
                                <div class="form-control-modern fs-5 fw-bold text-danger" id="equipment-depreciation-box">0.000</div>
                            </div>
                        </div>
                        <div class="depreciation-note">* إهلاك المعدات هو نسبة من إجمالي تكلفة المواد الأولية.</div>
                    </div>
                </div>
                
                <div class="card-theme-container">
                    <div class="card-header-theme"><i class="bi bi-currency-dollar"></i> ملخص التكاليف والأسعار</div>
                    <div class="p-4">
                        <div class="row g-4 align-items-center text-center">
                            <div class="col-md-4 order-md-1"><label class="summary-label">التكلفة الإجمالية للعلبة</label><div class="form-control-modern summary-input-large d-flex align-items-center justify-content-center text-blue-custom" id="grand-total-cost">0.000 د.ب</div></div>
                            <div class="col-md-4 order-md-2"><label class="summary-label">سعر البيع المقترح</label><div class="form-control-modern summary-input-large d-flex align-items-center justify-content-center text-orange-custom" id="suggested-price">0.000 د.ب</div><div class="profit-btn-display profit-btn-orange" id="suggested-profit">هامش الربح: 0.000 د.ب (0%)</div></div>
                            <div class="col-md-4 order-md-3"><label class="summary-label">سعر البيع النهائي</label><input type="number" class="form-control-modern summary-input-large" id="final-price-input" step="0.001" placeholder="0.000"><div class="profit-btn-display profit-btn-green" id="final-profit">هامش الربح: 0.000 د.ب (0.0%)</div></div>
                        </div>
                        <div class="save-btn-container"><button class="save-btn-custom" onclick="saveProduct()"><i class="bi bi-save"></i> حفظ المنتج</button></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="invoices-main" class="page">
            <h3 class="mb-4 fw-bold text-primary">الفواتير</h3>
            <div class="card-modern">
                <div class="card-header-modern"><span>سجل الفواتير</span><button class="btn btn-success-modern btn-sm" onclick="openInvoiceModal()">جديد</button></div>
                <div class="card-body-modern p-0"><div class="table-responsive"><table class="table-modern" id="invoices-table"><thead><tr><th>التاريخ</th><th>العميل</th><th>المنتج</th><th>الإجمالي</th><th>الحالة</th><th>الإجراءات</th></tr></thead><tbody id="invoices-tbody"></tbody></table></div></div>
            </div>
        </div>

        <div id="budget-ops" class="page">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="fw-bold text-primary m-0"><i class="bi bi-wallet2"></i> العمليات المالية</h3>
            </div>
            <div class="filter-wrapper"><div class="row align-items-center g-2"><div class="col-auto"><i class="bi bi-filter text-primary fs-5"></i></div><div class="col-md-4"><select id="ops-month-filter" class="form-select-modern" onchange="toggleFilterInputs('ops')"></select></div><div class="col-md-7" id="ops-filter-custom-div" style="display:none;"><div class="d-flex gap-2 align-items-center"><input type="date" id="ops-filter-from" class="form-control-modern" placeholder="من"><input type="date" id="ops-filter-to" class="form-control-modern" placeholder="إلى"><button class="btn btn-primary-modern btn-sm" onclick="renderAllTables()">تطبيق</button></div></div></div></div>
            <ul class="nav nav-pills nav-tabs-modern"><li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#production-tab">الإنتاج</button></li><li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#expenses-tab">المصروفات</button></li><li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#financials-tab">الخزينة</button></li></ul>
            <div class="tab-content">
                <div class="tab-pane fade show active" id="production-tab"><div class="card-modern"><div class="card-header-modern"><span>الإنتاج</span><button class="btn btn-primary-modern btn-sm" onclick="openProductionModal()">جديد</button></div><div class="card-body-modern p-0"><div class="table-responsive"><table class="table-modern" id="production-table"><thead><tr><th>التاريخ</th><th>الصنف</th><th>العلب</th><th>التكلفة</th><th>متوسط الكيلو</th><th>الإجراءات</th></tr></thead><tbody id="production-tbody"></tbody></table></div></div></div></div>
                <div class="tab-pane fade" id="expenses-tab"><ul class="nav nav-pills nav-tabs-modern justify-content-center mb-3"><li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#exp-purchases">المشتريات</button></li><li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#exp-salaries">الرواتب</button></li></ul><div class="tab-content"><div class="tab-pane fade show active" id="exp-purchases"><div class="card-modern"><div class="card-header-modern"><span>المشتريات</span><button class="btn btn-primary-modern btn-sm" onclick="openPurchaseModal()">جديد</button></div><div class="card-body-modern p-0"><table class="table-modern" id="purchases-table"><thead><tr><th>التاريخ</th><th>الصنف</th><th>العدد</th><th>السعر</th><th>المجموع</th><th>التصنيف</th><th>الإجراءات</th></tr></thead><tbody id="purchases-tbody"></tbody></table></div></div></div><div class="tab-pane fade" id="exp-salaries"><div class="card-modern"><div class="card-header-modern"><span>الرواتب</span><button class="btn btn-warning-modern btn-sm" onclick="openSalaryModal()">جديد</button></div><div class="card-body-modern p-0"><table class="table-modern" id="salaries-table"><thead><tr><th>التاريخ</th><th>البند</th><th>المبلغ</th><th>الحالة</th><th>تاريخ الدفع</th><th>الإجراءات</th></tr></thead><tbody id="salaries-tbody"></tbody></table></div></div></div></div></div>
                <div class="tab-pane fade" id="financials-tab"><div class="row mb-3"><div class="col-md-6"><button class="btn btn-success-modern w-100" onclick="openTransactionModal('in')">استلام مبلغ</button></div><div class="col-md-6"><button class="btn btn-danger-modern w-100" onclick="openTransactionModal('out')">استرداد مبلغ</button></div></div><div class="card-modern"><div class="card-body-modern p-0"><table class="table-modern" id="transactions-table"><thead><tr><th>التاريخ</th><th>النوع</th><th>المبلغ</th><th>الطريقة</th><th>ملاحظات</th><th>الإجراءات</th></tr></thead><tbody id="transactions-tbody"></tbody></table></div></div></div>
            </div>
        </div>

        <div id="settings-page" class="page">
            <h3 class="mb-4 fw-bold text-primary">الإعدادات</h3>
            <div class="card-modern">
                <div class="card-header-modern">الإعدادات العامة</div>
                <div class="card-body-modern settings-card-body">
                    <div class="row g-4">
                        <div class="col-md-6 settings-input-group">
                            <label class="settings-label">اسم المشروع (عربي)</label>
                            <input type="text" class="form-control-modern" id="setting-project-ar" placeholder="مثال: شكلمة">
                        </div>
                        <div class="col-md-6 settings-input-group">
                            <label class="settings-label">اسم المشروع (إنجليزي)</label>
                            <input type="text" class="form-control-modern" id="setting-project-en" placeholder="Example: Shkalma">
                        </div>
                        
                        <div class="col-md-12 settings-input-group">
                            <label class="settings-label">شعار المشروع</label>
                            <div class="logo-upload-wrapper">
                                <div class="logo-controls">
                                    <input type="file" id="setting-logo-upload" class="form-control-modern mb-2" accept="image/*" onchange="handleLogoUpload(this)">
                                    <button class="btn btn-danger-modern btn-sm" onclick="removeLogo()"><i class="bi bi-trash"></i> إزالة الشعار الحالي</button>
                                </div>
                                <div class="logo-preview-box" onclick="enlargeLogo()">
                                    <img id="setting-logo-preview" src="" alt="Preview" style="display:none;">
                                    <div id="logo-placeholder" class="logo-placeholder-text">معاينة الشعار<br><small>(اضغط للتكبير)</small></div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6 settings-input-group">
                            <label class="settings-label">العملة</label>
                            <select class="form-select-modern" id="setting-currency" onchange="updateCurrency()">
                                <option value="BHD">دينار بحريني (د.ب)</option>
                                <option value="SAR">ريال سعودي (ر.س)</option>
                                <option value="AED">درهم إماراتي (د.إ)</option>
                                <option value="QAR">ريال قطري (ر.ق)</option>
                                <option value="KWD">دينار كويتي (د.ك)</option>
                                <option value="OMR">ريال عماني (ر.ع)</option>
                                <option value="USD">دولار أمريكي ($)</option>
                                <option value="EUR">يورو (€)</option>
                            </select>
                        </div>
                    </div>
                    <div class="save-btn-container mt-4">
                        <button class="save-btn-custom" onclick="saveSettings()"><i class="bi bi-save"></i> حفظ الإعدادات</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="invoiceModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-success text-white"><h5 class="modal-title">فاتورة جديدة</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="inv-id"><div class="mb-2"><label>التاريخ</label><input type="date" class="form-control-modern" id="inv-date"></div><div class="mb-2"><label>العميل</label><input type="text" class="form-control-modern" id="inv-customer"></div><div class="mb-2"><label>الهاتف</label><input type="tel" class="form-control-modern" id="inv-phone"></div><div class="mb-2"><label>المنتج</label><select class="form-select-modern" id="inv-product" onchange="calcInvTotal()"></select></div><div class="row mb-2"><div class="col-6"><label>العدد</label><input type="number" class="form-control-modern" id="inv-qty" value="1" oninput="calcInvTotal()"></div><div class="col-6"><label>الإجمالي</label><input type="number" class="form-control-modern bg-light" id="inv-total" readonly></div></div><div class="mb-2"><label>الحالة</label><select class="form-select-modern" id="inv-status" onchange="toggleInvMethod()"><option value="Paid">مدفوع</option><option value="Unpaid">غير مدفوع</option></select></div><div class="mb-2" id="inv-method-div"><label>طريقة الدفع</label><select class="form-select-modern" id="inv-method"><option value="Cash">كاش</option><option value="Benefit">بنفت</option></select></div></div><div class="modal-footer"><button class="btn btn-success-modern" onclick="saveInvoice()">حفظ</button></div></div></div></div>
    <div class="modal fade" id="productionModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header bg-primary text-white"><h5 class="modal-title">تسجيل ناتج</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="prod-id"><div class="row g-2 mb-3"><div class="col-6"><label>التاريخ</label><input type="date" class="form-control-modern" id="prod-date"></div><div class="col-6"><label>الصنف</label><select class="form-select-modern" id="prod-name"></select></div></div><div class="row g-2 mb-3"><div class="col-6"><label>الوزن</label><input type="text" class="form-control-modern" id="prod-weight"></div><div class="col-6"><label>عدد العلب</label><input type="number" class="form-control-modern" id="prod-count" oninput="calcProdTotal()"></div></div><h6>المنتجات المستخدمة</h6><table class="table-modern mb-2" id="prod-ing-table"><tbody></tbody></table><button class="btn btn-sm btn-light border mb-3" onclick="addProdIng()">+ منتج</button><h6>تكاليف تشغيلية</h6><table class="table-modern mb-2" id="prod-op-table"><tbody></tbody></table><button class="btn btn-sm btn-light border mb-3" onclick="addProdOp()">+ تكلفة</button><div class="row"><div class="col-6"><label>الإجمالي</label><input id="prod-total" class="form-control-modern" readonly></div><div class="col-6"><label>للوحدة</label><input id="prod-unit" class="form-control-modern" readonly></div></div></div><div class="modal-footer"><button class="btn btn-primary-modern" onclick="saveProduction()">حفظ</button></div></div></div></div>
    <div class="modal fade" id="purchaseModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">مشتريات</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="pur-id"><div class="mb-2"><label>التاريخ</label><input type="date" class="form-control-modern" id="pur-date"></div><div class="mb-2"><label>الصنف</label><input type="text" class="form-control-modern" id="pur-item"></div><div class="row mb-2"><div class="col-6"><label>العدد</label><input type="number" class="form-control-modern" id="pur-count"></div><div class="col-6"><label>السعر</label><input type="number" class="form-control-modern" id="pur-amount"></div></div><div class="mb-2"><label>التصنيف</label><select class="form-select-modern" id="pur-cat"></select></div><div class="mb-2"><label>الحالة</label><select class="form-select-modern" id="pur-status" onchange="togglePurMethod()"><option value="Paid">مدفوع</option><option value="Unpaid">غير مدفوع</option></select></div><div id="pur-method-div" style="display:none"><div class="mb-2"><label>الطريقة</label><select class="form-select-modern" id="pur-method"><option value="Cash">كاش</option><option value="Benefit">بنفت</option></select></div><div class="mb-2"><label>تاريخ الدفع</label><input type="date" class="form-control-modern" id="pur-pay-date"></div></div></div><div class="modal-footer"><button class="btn btn-primary-modern" onclick="savePurchase()">حفظ</button></div></div></div></div>
    <div class="modal fade" id="salaryModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">راتب</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="sal-id"><div class="mb-2"><label>التاريخ</label><input type="date" class="form-control-modern" id="sal-date"></div><div class="mb-2"><label>التصنيف</label><select class="form-select-modern" id="sal-cat"><option>عمال</option><option>وجبات</option><option>سيارة</option></select></div><div class="mb-2"><label>المبلغ</label><input type="number" class="form-control-modern" id="sal-amount"></div><div class="mb-2"><label>الحالة</label><select class="form-select-modern" id="sal-status" onchange="toggleSalMethod()"><option value="Unpaid">غير مدفوع</option><option value="Paid">مدفوع</option></select></div><div id="sal-pay-div" class="d-none"><div class="mb-2"><label>الطريقة</label><select class="form-select-modern" id="sal-method"><option>Cash</option><option>Benefit</option></select></div><div class="mb-2"><label>تاريخ الدفع</label><input type="date" class="form-control-modern" id="sal-pay-date"></div></div><div class="mb-2"><textarea class="form-control-modern" id="sal-notes" placeholder="ملاحظات"></textarea></div></div><div class="modal-footer"><button class="btn btn-warning-modern" onclick="saveSalary()">حفظ</button></div></div></div></div>
    <div class="modal fade" id="transModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="trans-title"></h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="trans-id"><input type="hidden" id="trans-type"><div class="mb-2"><label>التاريخ</label><input type="date" class="form-control-modern" id="trans-date"></div><div class="mb-2"><label>المبلغ</label><input type="number" class="form-control-modern" id="trans-amount"></div><div class="mb-2"><label>الطريقة</label><select class="form-select-modern" id="trans-method"><option>Cash</option><option>Benefit</option></select></div><div class="mb-2"><textarea class="form-control-modern" id="trans-notes" placeholder="ملاحظات"></textarea></div></div><div class="modal-footer"><button class="btn btn-success-modern" onclick="saveTransaction()">حفظ</button></div></div></div></div>
    
    <div class="modal fade" id="imageModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content bg-transparent border-0"><div class="modal-body text-center"><img src="" id="modal-img-full" class="modal-logo-img"><button type="button" class="btn btn-light mt-3" data-bs-dismiss="modal">إغلاق</button></div></div></div></div>

    <div class="modal fade" id="previewModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">معاينة</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="preview-modal-body"></div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let appData = { 
            products: [], 
            budget: { purchases: [], salaries: [], transactions: [], productions: [], invoices: [] },
            settings: { nameAr: 'شكلمة', nameEn: 'Shkalma Sweets', logo: '', currency: 'BHD' }
        };
        const categoriesList = ["مواد أولية", "تغليف", "أدوات ومعدات", "تسويق", "صيانة", "أخرى"];
        const currencySymbols = { 'BHD': 'د.ب', 'SAR': 'ر.س', 'AED': 'د.إ', 'QAR': 'ر.ق', 'KWD': 'د.ك', 'OMR': 'ر.ع', 'USD': '$', 'EUR': '€' };
        let productCounter = 1;
        let chartInstance = null;

        function loadData() {
            const d = localStorage.getItem('baizaAppData');
            if (d) {
                const p = JSON.parse(d);
                appData = { 
                    products: p.products||[], 
                    budget: { purchases: p.budget?.purchases||[], salaries: p.budget?.salaries||[], transactions: p.budget?.transactions||[], productions: p.budget?.productions||[], invoices: p.budget?.invoices||[] },
                    settings: p.settings || { nameAr: 'شكلمة', nameEn: 'Shkalma Sweets', logo: '', currency: 'BHD' }
                };
                appData.budget.purchases.forEach(x => { if(x.remaining === undefined) x.remaining = parseFloat(x.count); });
                appData.budget.salaries.forEach(x => { if(x.isUsedInProduction === undefined) x.isUsedInProduction = false; });
            }
            productCounter = appData.products.length + 1;
            applySettings();
        }
        
        function saveData() { 
            try {
                localStorage.setItem('baizaAppData', JSON.stringify(appData));
            } catch (e) {
                alert('مساحة التخزين ممتلئة. لا يمكن حفظ البيانات، يرجى تقليل حجم البيانات أو إزالة الشعار.');
                console.error(e);
            }
        }
        
        function formatMoney(n) { 
            const cur = appData.settings.currency;
            const sym = currencySymbols[cur] || 'د.ب';
            const decimals = (cur === 'BHD' || cur === 'KWD' || cur === 'OMR') ? 3 : 2;
            return parseFloat(n||0).toFixed(decimals) + ' ' + sym; 
        }
        function formatCount(n) { return parseFloat(n||0).toFixed(2); }

        function initRouting() { 
            window.addEventListener('hashchange', () => showPage(window.location.hash.substring(1) || 'dashboard')); 
            showPage(window.location.hash.substring(1) || 'dashboard'); 
        }

        function showPage(id) {
            if(!id) id = 'dashboard';
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            const activePage = document.getElementById(id);
            if(activePage) {
                activePage.classList.add('active');
            } else {
                document.getElementById('dashboard').classList.add('active');
            }
            
            document.querySelectorAll('.sidebar .nav-link').forEach(l => {
                l.classList.remove('active');
                if(l.dataset.page === id) l.classList.add('active');
            });
            
            if(id === 'product-main') { switchProductView('list'); renderProducts(); }
            if(id === 'dashboard') updateBudgetUI();
            if(id === 'invoices-main') renderAllTables();
            if(id === 'budget-ops') { populateFilter('ops-month-filter'); renderAllTables(); }
            
            document.getElementById('sidebar').classList.remove('show');
            window.scrollTo(0, 0);
        }

        document.addEventListener('click', e => { 
            const l = e.target.closest('[data-page]'); 
            if(l) { 
                e.preventDefault(); 
                const pageId = l.dataset.page;
                window.location.hash = pageId; 
                showPage(pageId);
            } 
        });

        document.getElementById('sidebarToggle').addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('show');
        });

        // --- Settings Functions ---
        function applySettings() {
            document.getElementById('sidebar-project-name-ar').innerText = appData.settings.nameAr;
            document.getElementById('sidebar-project-name-en').innerText = appData.settings.nameEn;
            document.title = appData.settings.nameAr + ' - ' + appData.settings.nameEn;
            
            // Logo Logic
            const logoUrl = appData.settings.logo || 'https://i.imgur.com/image_f84c5f.png'; 
            document.getElementById('sidebar-footer-img').src = logoUrl;
            document.getElementById('setting-logo-preview').src = logoUrl;
            if(appData.settings.logo) {
                document.getElementById('setting-logo-preview').style.display = 'block';
                document.getElementById('logo-placeholder').style.display = 'none';
            }

            // Inputs in Settings Page
            if(document.getElementById('setting-project-ar')) document.getElementById('setting-project-ar').value = appData.settings.nameAr;
            if(document.getElementById('setting-project-en')) document.getElementById('setting-project-en').value = appData.settings.nameEn;
            if(document.getElementById('setting-currency')) document.getElementById('setting-currency').value = appData.settings.currency;

            updateCurrencySymbol();
        }

        function saveSettings() {
            if (!appData.settings) appData.settings = {};

            const arInput = document.getElementById('setting-project-ar');
            const enInput = document.getElementById('setting-project-en');
            const curInput = document.getElementById('setting-currency');

            if(arInput) appData.settings.nameAr = arInput.value;
            if(enInput) appData.settings.nameEn = enInput.value;
            if(curInput) appData.settings.currency = curInput.value;

            saveData();
            applySettings();
            updateCurrencySymbol();
            alert('تم حفظ الإعدادات بنجاح');
        }

        function handleLogoUpload(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const MAX_SIZE = 300;
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > MAX_SIZE) {
                                height *= MAX_SIZE / width;
                                width = MAX_SIZE;
                            }
                        } else {
                            if (height > MAX_SIZE) {
                                width *= MAX_SIZE / height;
                                height = MAX_SIZE;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        // Save as PNG to keep transparency and colors
                        const dataUrl = canvas.toDataURL('image/png');
                        appData.settings.logo = dataUrl;
                        
                        document.getElementById('setting-logo-preview').src = dataUrl;
                        document.getElementById('setting-logo-preview').style.display = 'block';
                        document.getElementById('logo-placeholder').style.display = 'none';
                    };
                };
                reader.readAsDataURL(file);
            }
        }

        function removeLogo() {
            appData.settings.logo = '';
            document.getElementById('setting-logo-upload').value = '';
            document.getElementById('setting-logo-preview').style.display = 'none';
            document.getElementById('logo-placeholder').style.display = 'block';
            saveData(); 
            applySettings();
        }

        function enlargeLogo() {
            const src = document.getElementById('sidebar-footer-img').src;
            document.getElementById('modal-img-full').src = src;
            new bootstrap.Modal(document.getElementById('imageModal')).show();
        }

        function updateCurrency() {
            const tempCurrency = document.getElementById('setting-currency').value;
            const sym = currencySymbols[tempCurrency] || 'د.ب';
            document.documentElement.style.setProperty('--currency-symbol', `"${sym}"`);
        }

        function updateCurrencySymbol() {
            const sym = currencySymbols[appData.settings.currency] || 'د.ب';
            document.documentElement.style.setProperty('--currency-symbol', `"${sym}"`);
            if(document.getElementById('dashboard').classList.contains('active')) updateBudgetUI();
            if(document.getElementById('product-main').classList.contains('active')) {
                calcProduct(); 
                renderProducts(); 
            }
            renderAllTables(); 
        }

        function populateFilter(elementId) {
            const filter = document.getElementById(elementId);
            if(!filter) return;
            const currentMonth = new Date().toISOString().slice(0, 7);
            const dates = [...appData.budget.purchases, ...appData.budget.salaries, ...appData.budget.transactions, ...appData.budget.invoices, ...appData.budget.productions].map(x=>x.date);
            const months = [...new Set(dates.map(d=>d.substring(0,7)))].sort().reverse();
            filter.innerHTML = '';
            const currName = new Date().toLocaleDateString('ar-BH', { month: 'long', year: 'numeric' });
            filter.add(new Option(`الشهر الحالي (${currName})`, currentMonth));
            filter.add(new Option('كل الأشهر', 'all'));
            filter.add(new Option('فترة مخصصة', 'custom'));
            months.forEach(m => { if(m !== currentMonth) { const label = new Date(m + '-01').toLocaleDateString('ar-BH', { month: 'long', year: 'numeric' }); filter.add(new Option(label, m)); } });
            filter.value = currentMonth;
        }

        function toggleFilterInputs(prefix) {
            const type = document.getElementById(prefix + '-month-filter').value;
            const customDiv = document.getElementById(prefix + '-filter-custom-div');
            if(customDiv) customDiv.style.display = type === 'custom' ? 'block' : 'none';
            if(prefix === 'budget' && type !== 'custom') updateBudgetUI();
            if(prefix === 'ops' && type !== 'custom') renderAllTables();
        }

        function checkDate(date) {
            if(!date) return false;
            const page = document.querySelector('.page.active').id;
            const filterId = (page === 'dashboard') ? 'budget-month-filter' : 'ops-month-filter';
            const typeElement = document.getElementById(filterId);
            if(!typeElement) return true; 
            const type = typeElement.value;
            if(type === 'all') return true;
            if(type === 'custom') {
                const p = (page === 'dashboard') ? 'budget' : 'ops';
                const f = document.getElementById(p + '-filter-from').value;
                const t = document.getElementById(p + '-filter-to').value;
                return (!f || date >= f) && (!t || date <= t);
            }
            return date.startsWith(type);
        }

        function switchProductView(view) {
            document.getElementById('view-product-list').style.display = view === 'list' ? 'block' : 'none';
            document.getElementById('view-product-calc').style.display = view === 'calc' ? 'block' : 'none';
            document.querySelector(`[onclick*="'list'"]`).classList.toggle('active', view === 'list');
            document.querySelector(`[onclick*="'calc'"]`).classList.toggle('active', view === 'calc');
            if(view === 'list') renderProducts();
        }
        function renderProducts() {
            const tb = document.getElementById('products-list'); tb.innerHTML = '';
            appData.products.forEach((p, i) => {
                tb.innerHTML += `<tr><td>${p.code}</td><td>${p.name}</td><td>${p.totalCost}</td><td>${p.finalPrice}</td><td>${p.profitMargin}</td><td><span class="status-badge ${p.active?'status-active':'status-inactive'}">${p.active?'مفعل':'معطل'}</span></td><td><button class="btn btn-warning-modern btn-sm" onclick="toggleStatus(${i})"><i class="bi bi-power"></i></button> <button class="btn btn-primary-modern btn-sm" onclick="editProduct(${i})"><i class="bi bi-pencil"></i></button> <button class="btn btn-secondary-modern btn-sm" onclick="viewProduct(${i})"><i class="bi bi-eye"></i></button> <button class="btn btn-danger-modern btn-sm" onclick="delProduct(${i})"><i class="bi bi-trash"></i></button></td></tr>`;
            });
        }
        function toggleStatus(i) { appData.products[i].active = !appData.products[i].active; saveData(); renderProducts(); }
        
        function updateCalcLabels() {
            const type = document.getElementById('calc-unit-type').value;
            document.getElementById('lbl-prod-qty-salary').innerText = `الكمية المنتجة (${type})`;
            document.getElementById('lbl-prod-qty-weight').innerText = `الكمية المنتجة (لكل ${type})`;
            document.getElementById('lbl-labor-cost').innerText = `تكلفة العمال (لكل ${type})`;
            document.getElementById('lbl-total-labor-cost-footer').innerHTML = `إجمالي تكلفة اليد العاملة لل${type} <span id="total-labor-cost-display">0.000</span> ${currencySymbols[appData.settings.currency]||'د.ب'}`;
            calcProduct();
        }

        function toggleLaborMethod() { const isSal = document.getElementById('laborMethodSalary').checked; document.getElementById('labor-salary-container').style.display = isSal ? 'block':'none'; document.getElementById('labor-weight-container').style.display = isSal ? 'none':'block'; calcProduct(); }
        
        function calcProduct() {
            const unitType = document.getElementById('calc-unit-type').value;
            let totalMat = 0;
            document.querySelectorAll('#materials-tbody tr').forEach(r => { const i = r.querySelectorAll('input'); const cost = (parseFloat(i[1].value)/parseFloat(i[2].value)) * parseFloat(i[3].value) || 0; r.querySelector('.material-cost').innerText = cost.toFixed(3); totalMat += cost; });
            let totalPack = 0;
            document.querySelectorAll('#packaging-tbody tr').forEach(r => { const i = r.querySelectorAll('input'); const cost = (parseFloat(i[1].value)/parseFloat(i[2].value)) * parseFloat(i[3].value) || 0; r.querySelector('.packaging-cost').innerText = cost.toFixed(3); totalPack += cost; });
            
            const isSal = document.getElementById('laborMethodSalary').checked;
            let prodQty = 1;
            let laborTotalPerUnit = 0;

            if(isSal) {
                const sal = parseFloat(document.querySelector('.salary').value)||0; 
                const hrs = parseFloat(document.querySelector('.hours').value)||0; 
                prodQty = parseFloat(document.querySelector('.pieces').value)||1;
                const hourlyRate = sal / 240; 
                document.querySelector('.hourly-cost').innerText = hourlyRate.toFixed(3);
                const totalBatchLabor = hourlyRate * hrs;
                laborTotalPerUnit = totalBatchLabor / prodQty;
            } else {
                prodQty = parseFloat(document.getElementById('labor-weight-qty').value)||1;
                const directCost = parseFloat(document.getElementById('labor-direct-cost').value) || 0;
                laborTotalPerUnit = directCost;
            }

            const depRate = parseFloat(document.getElementById('depreciation-rate').value)||0;
            const totalDepreciation = totalMat * (depRate / 100);
            const depPerUnit = totalDepreciation / prodQty;
            
            document.getElementById('equipment-depreciation-total').innerText = totalDepreciation.toFixed(3);
            document.getElementById('equipment-depreciation-box').innerText = depPerUnit.toFixed(3);

            const matPerUnit = totalMat / prodQty;
            const packPerUnit = totalPack / prodQty; 

            document.getElementById('total-materials-display').innerText = totalMat.toFixed(3);
            document.getElementById('lbl-mat-per-unit').innerHTML = `إجمالي تكلفة المواد الأولية (لكل ${unitType}) <span id="total-materials-per-unit-display">${matPerUnit.toFixed(3)}</span> ${currencySymbols[appData.settings.currency]||'د.ب'}`;
            document.getElementById('total-packaging-display').innerText = totalPack.toFixed(3);
            document.getElementById('lbl-pack-per-unit').innerHTML = `إجمالي تكلفة التغليف (لكل ${unitType}) <span id="total-packaging-per-unit-display">${packPerUnit.toFixed(3)}</span> ${currencySymbols[appData.settings.currency]||'د.ب'}`;
            document.getElementById('total-labor-cost-display').innerText = laborTotalPerUnit.toFixed(3);

            const grandTotalUnit = matPerUnit + packPerUnit + laborTotalPerUnit + depPerUnit;

            document.getElementById('summary-materials').innerText = formatMoney(matPerUnit); 
            document.getElementById('summary-packaging').innerText = formatMoney(packPerUnit); 
            document.getElementById('summary-labor').innerText = formatMoney(laborTotalPerUnit); 
            document.getElementById('summary-depreciation').innerText = formatMoney(depPerUnit); 
            document.getElementById('grand-total-cost').innerText = formatMoney(grandTotalUnit);
            
            const profitRate = parseFloat(document.getElementById('profit-rate').value)||0; 
            const suggested = grandTotalUnit * (1 + profitRate/100); 
            document.getElementById('suggested-price').innerText = formatMoney(suggested);
            
            const finalP = parseFloat(document.getElementById('final-price-input').value)||suggested; 
            document.getElementById('summary-sale-price').innerText = formatMoney(finalP);
            
            const profit = finalP - grandTotalUnit;
            const profitTxt = `هامش الربح: ${formatMoney(profit)} (${grandTotalUnit>0?(profit/grandTotalUnit*100).toFixed(1):0}%)`;
            document.getElementById('final-profit').innerText = profitTxt; 
            document.getElementById('suggested-profit').innerText = `هامش الربح: ${formatMoney(suggested-grandTotalUnit)} (${profitRate}%)`;
            document.getElementById('summary-profit-margin').innerText = formatMoney(profit);
        }

        let editingIdx = -1;
        function saveProduct() {
            const p = {
                code: document.getElementById('product-code').value, name: document.getElementById('product-name').value, active: true,
                finalPrice: formatMoney(parseFloat(document.getElementById('final-price-input').value)),
                totalCost: document.getElementById('grand-total-cost').innerText, profitMargin: document.getElementById('final-profit').innerText,
                materialsData: [], packagingData: [], laborData: {}, depreciationRate: document.getElementById('depreciation-rate').value,
                laborMethod: document.getElementById('laborMethodSalary').checked ? 'salary' : 'weight',
                unitType: document.getElementById('calc-unit-type').value
            };
            document.querySelectorAll('#materials-tbody tr').forEach(r => { const i = r.querySelectorAll('input'); p.materialsData.push({name:i[0].value, count:i[2].value, price:i[1].value, used:i[3].value}); });
            document.querySelectorAll('#packaging-tbody tr').forEach(r => { const i = r.querySelectorAll('input'); p.packagingData.push({name:i[0].value, count:i[2].value, price:i[1].value, used:i[3].value}); });
            
            if(p.laborMethod === 'salary') { 
                p.laborData = { salary: document.querySelector('.salary').value, hours: document.querySelector('.hours').value, pieces: document.querySelector('.pieces').value }; 
            } else { 
                p.laborData = { directCost: document.getElementById('labor-direct-cost').value, qty: document.getElementById('labor-weight-qty').value }; 
            }
            
            if(editingIdx >= 0) appData.products[editingIdx] = p; else appData.products.push(p);
            saveData(); switchProductView('list');
        }

        function editProduct(i) { 
            editingIdx = i; 
            switchProductView('calc');
            const p = appData.products[i];
            
            // Basic Info
            document.getElementById('product-name').value = p.name;
            document.getElementById('product-code').value = p.code;
            // Extract numbers from formatted string if needed, or better, store raw values in object. For now parsing:
            document.getElementById('final-price-input').value = parseFloat(p.finalPrice);
            // Depreciation rate needs to be stored in product object, added default fallback
            document.getElementById('depreciation-rate').value = p.depreciationRate || 10;
            document.getElementById('profit-rate').value = 0; // Needs logic to reverse calc profit rate or store it. Setting 0 default.
            
            // Unit Type
            document.getElementById('calc-unit-type').value = p.unitType || 'علبة';
            updateCalcLabels();

            // Labor
            if (p.laborMethod === 'salary') {
                document.getElementById('laborMethodSalary').checked = true;
                if(p.laborData) {
                    document.querySelector('.salary').value = p.laborData.salary;
                    document.querySelector('.hours').value = p.laborData.hours;
                    document.querySelector('.pieces').value = p.laborData.pieces;
                }
            } else {
                document.getElementById('laborMethodWeight').checked = true;
                if(p.laborData) {
                    document.getElementById('labor-direct-cost').value = p.laborData.directCost;
                    document.getElementById('labor-weight-qty').value = p.laborData.qty;
                }
            }
            toggleLaborMethod();

            // Materials
            const matBody = document.getElementById('materials-tbody');
            matBody.innerHTML = '';
            if (p.materialsData) {
                p.materialsData.forEach(m => {
                    matBody.insertAdjacentHTML('beforeend', `<tr><td><input class="form-control-modern material-name" value="${m.name}"></td><td><input type="number" class="form-control-modern material-price" step="0.001" value="${m.price}"></td><td><input type="number" class="form-control-modern material-count" value="${m.count}"></td><td><input type="number" class="form-control-modern material-used" value="${m.used}"></td><td class="material-cost fw-bold">0.000</td><td><button class="btn btn-danger-modern btn-sm" onclick="this.closest('tr').remove();calcProduct()">x</button></td></tr>`);
                });
            }

            // Packaging
            const packBody = document.getElementById('packaging-tbody');
            packBody.innerHTML = '';
            if (p.packagingData) {
                p.packagingData.forEach(pk => {
                    packBody.insertAdjacentHTML('beforeend', `<tr><td><input class="form-control-modern packaging-name" value="${pk.name}"></td><td><input type="number" class="form-control-modern packaging-price" step="0.001" value="${pk.price}"></td><td><input type="number" class="form-control-modern packaging-count" value="${pk.count}"></td><td><input type="number" class="form-control-modern packaging-used" value="${pk.used}"></td><td class="packaging-cost fw-bold">0.000</td><td><button class="btn btn-danger-modern btn-sm" onclick="this.closest('tr').remove();calcProduct()">x</button></td></tr>`);
                });
            }
            
            attachEvents();
            calcProduct();
        }

        function viewProduct(i) {
            const p = appData.products[i];
            const content = `
                <h5 class="text-primary text-center mb-3">${p.name} (${p.code})</h5>
                <table class="table table-bordered">
                    <tr><th>التكلفة الإجمالية</th><td>${p.totalCost}</td></tr>
                    <tr><th>سعر البيع</th><td>${p.finalPrice}</td></tr>
                    <tr><th>هامش الربح</th><td>${p.profitMargin}</td></tr>
                </table>
                <div class="text-center mt-3"><small class="text-muted">للتعديل، اضغط على زر التعديل في القائمة</small></div>
            `;
            document.getElementById('preview-modal-body').innerHTML = content;
            new bootstrap.Modal(document.getElementById('previewModal')).show();
        }

        function previewItem(type, i) {
            let item, title = "", content = "";
            if (type === 'production') {
                item = appData.budget.productions[i];
                title = "تفاصيل الإنتاج";
                content = `<p><strong>التاريخ:</strong> ${item.date}</p><p><strong>الصنف:</strong> ${item.name}</p><p><strong>العلب:</strong> ${item.boxCount}</p><p><strong>التكلفة الكلية:</strong> ${formatMoney(item.totalCost)}</p>`;
            } else if (type === 'purchase') {
                item = appData.budget.purchases[i];
                title = "تفاصيل المشتريات";
                content = `<p><strong>التاريخ:</strong> ${item.date}</p><p><strong>الصنف:</strong> ${item.item}</p><p><strong>العدد:</strong> ${item.count}</p><p><strong>السعر:</strong> ${formatMoney(item.amount)}</p><p><strong>المجموع:</strong> ${formatMoney(item.count*item.amount)}</p>`;
            } else if (type === 'salary') {
                item = appData.budget.salaries[i];
                title = "تفاصيل الراتب";
                content = `<p><strong>التاريخ:</strong> ${item.date}</p><p><strong>التصنيف:</strong> ${item.category}</p><p><strong>المبلغ:</strong> ${formatMoney(item.amount)}</p><p><strong>الحالة:</strong> ${item.status}</p>`;
            } else if (type === 'transaction') {
                item = appData.budget.transactions[i];
                title = "تفاصيل العملية";
                content = `<p><strong>التاريخ:</strong> ${item.date}</p><p><strong>النوع:</strong> ${item.type}</p><p><strong>المبلغ:</strong> ${formatMoney(item.amount)}</p><p><strong>ملاحظات:</strong> ${item.notes}</p>`;
            } else if (type === 'invoice') {
                item = appData.budget.invoices[i];
                title = "تفاصيل الفاتورة";
                content = `<p><strong>التاريخ:</strong> ${item.date}</p><p><strong>العميل:</strong> ${item.customer}</p><p><strong>المنتج:</strong> ${item.productName}</p><p><strong>الإجمالي:</strong> ${formatMoney(item.total)}</p>`;
            }
            
            document.querySelector('#previewModal .modal-title').innerText = title;
            document.getElementById('preview-modal-body').innerHTML = content;
            new bootstrap.Modal(document.getElementById('previewModal')).show();
        }

        function delProduct(i) { if(confirm('حذف؟')) { appData.products.splice(i,1); saveData(); renderProducts(); } }
        function clearForm() { editingIdx=-1; document.querySelectorAll('#view-product-calc input').forEach(i=>i.value=''); document.getElementById('product-code').value="PRD-"+String(productCounter++).padStart(4,'0'); document.getElementById('materials-tbody').innerHTML = `<tr><td><input class="form-control-modern material-name"></td><td><input type="number" class="form-control-modern material-price" step="0.001"></td><td><input type="number" class="form-control-modern material-count" value="1"></td><td><input type="number" class="form-control-modern material-used"></td><td class="material-cost fw-bold">0.000</td><td><button class="btn btn-danger-modern btn-sm" onclick="this.closest('tr').remove();calcProduct()">x</button></td></tr>`; document.getElementById('packaging-tbody').innerHTML = `<tr><td><input class="form-control-modern packaging-name"></td><td><input type="number" class="form-control-modern packaging-price" step="0.001"></td><td><input type="number" class="form-control-modern packaging-count" value="1"></td><td><input type="number" class="form-control-modern packaging-used"></td><td class="packaging-cost fw-bold">0.000</td><td><button class="btn btn-danger-modern btn-sm" onclick="this.closest('tr').remove();calcProduct()">x</button></td></tr>`; attachEvents(); }
        document.getElementById('add-material').onclick = () => { document.getElementById('materials-tbody').insertAdjacentHTML('beforeend', `<tr><td><input class="form-control-modern material-name"></td><td><input type="number" class="form-control-modern material-price" step="0.001"></td><td><input type="number" class="form-control-modern material-count"></td><td><input type="number" class="form-control-modern material-used"></td><td class="material-cost fw-bold">0.000</td><td><button class="btn btn-danger-modern btn-sm" onclick="this.closest('tr').remove();calcProduct()">x</button></td></tr>`); attachEvents(); };
        document.getElementById('add-packaging').onclick = () => { document.getElementById('packaging-tbody').insertAdjacentHTML('beforeend', `<tr><td><input class="form-control-modern packaging-name"></td><td><input type="number" class="form-control-modern packaging-price" step="0.001"></td><td><input type="number" class="form-control-modern packaging-count"></td><td><input type="number" class="form-control-modern packaging-used"></td><td class="packaging-cost fw-bold">0.000</td><td><button class="btn btn-danger-modern btn-sm" onclick="this.closest('tr').remove();calcProduct()">x</button></td></tr>`); attachEvents(); };
        function attachEvents() { document.querySelectorAll('input').forEach(i => i.oninput = calcProduct); } attachEvents();

        function updateBudgetUI() { renderReport(); renderAllTables(); }

        function renderReport() {
            let cIn=0, bIn=0; 
            let cRef=0, bRef=0; 
            let cExp=0, bExp=0; 

            appData.budget.transactions.forEach(t => { 
                if(checkDate(t.date)) { 
                    if(t.type === 'in') {
                         t.method === 'Cash' ? cIn += parseFloat(t.amount) : bIn += parseFloat(t.amount);
                    } else {
                         t.method === 'Cash' ? cRef += parseFloat(t.amount) : bRef += parseFloat(t.amount); 
                    }
                } 
            });

            appData.budget.invoices.forEach(i => { 
                if(checkDate(i.date) && i.status === 'Paid') {
                    i.method === 'Cash' ? cIn += parseFloat(i.total) : bIn += parseFloat(i.total); 
                }
            });

            appData.budget.salaries.forEach(s => { 
                if(checkDate(s.date) && s.status === 'Paid') {
                    s.method === 'Cash' ? cExp += parseFloat(s.amount) : bExp += parseFloat(s.amount); 
                }
            });

            appData.budget.purchases.forEach(p => { 
                if(checkDate(p.date) && p.status === 'Paid') {
                    const amt = (parseFloat(p.count)*parseFloat(p.amount));
                    p.method === 'Cash' ? cExp += amt : bExp += amt; 
                }
            });

            document.getElementById('rep-cash-in').innerText = formatMoney(cIn); 
            document.getElementById('rep-benefit-in').innerText = formatMoney(bIn);
            document.getElementById('rep-cash-out').innerText = formatMoney(cRef); 
            document.getElementById('rep-benefit-out').innerText = formatMoney(bRef);
            
            const treasuryNet = (cIn + bIn) - (cRef + bRef);
            document.getElementById('rep-net').innerText = formatMoney(treasuryNet);
            
            const remCash = cIn - cRef - cExp;
            const remBenefit = bIn - bRef - bExp;

            document.getElementById('rem-cash').innerText = formatMoney(remCash);
            document.getElementById('rem-benefit').innerText = formatMoney(remBenefit);

            const purTotal = appData.budget.purchases.filter(p => checkDate(p.date)).reduce((a,b)=>a+(parseFloat(b.count)*parseFloat(b.amount)),0);
            const salTotal = appData.budget.salaries.filter(s => checkDate(s.date)).reduce((a,b)=>a+parseFloat(b.amount),0);
            const totalExpenses = purTotal + salTotal;
            
            const remEl = document.getElementById('rep-final-remainder');
            remEl.innerText = formatMoney(remCash + remBenefit);
            remEl.className = (remCash + remBenefit) >= 0 ? "report-val text-success" : "report-val text-danger";

            document.getElementById('rep-purchases-total').innerText = formatMoney(purTotal);
            document.getElementById('rep-salaries-total').innerText = formatMoney(salTotal);
            document.getElementById('rep-expenses-total').innerText = formatMoney(totalExpenses);

            const prods = appData.budget.productions.filter(p => checkDate(p.date));
            const prodListContainer = document.getElementById('production-list-container');
            prodListContainer.innerHTML = '';
            let prodGroups = {};
            prods.forEach(p => { if(!prodGroups[p.name]) prodGroups[p.name] = { boxes: 0, totalCost: 0 }; prodGroups[p.name].boxes += parseFloat(p.boxCount); prodGroups[p.name].totalCost += parseFloat(p.totalCost); });
            if(Object.keys(prodGroups).length === 0) prodListContainer.innerHTML = '<div class="text-muted text-center py-4">لا يوجد إنتاج</div>'; 
            else for (const [name, data] of Object.entries(prodGroups)) { const avgKilo = (data.totalCost / data.boxes) * 2; prodListContainer.innerHTML += `<div class="prod-item"><span class="prod-item-name">${name}</span><div class="prod-item-stat"><span>عدد العلب المنتجة</span><span class="prod-item-val">${formatCount(data.boxes)}</span></div><div class="prod-item-stat"><span>متوسط تكلفة الكيلو</span><span class="prod-item-val text-primary">${formatMoney(avgKilo)}</span></div></div>`; }

            const invs = appData.budget.invoices.filter(i => checkDate(i.date));
            const paid = invs.filter(i => i.status === 'Paid');
            let productCosts = {}; appData.budget.productions.forEach(p => { if(!productCosts[p.name]) productCosts[p.name] = []; productCosts[p.name].push(parseFloat(p.boxValue)); });
            let totalSales = paid.reduce((a,b)=>a+parseFloat(b.total),0);
            let totalCOGS = 0; paid.forEach(inv => { const costs = productCosts[inv.productName]; const avg = costs ? costs.reduce((a,b)=>a+b,0)/costs.length : 0; totalCOGS += parseFloat(inv.qty) * avg; });
            document.getElementById('report-net-benefit').innerText = formatMoney(totalSales - totalCOGS);
            document.getElementById('report-net-budget').innerText = formatMoney(totalSales - totalExpenses);

            const cats = {}; appData.budget.purchases.filter(p=>checkDate(p.date)).forEach(p => { cats[p.category] = (cats[p.category]||0) + (parseFloat(p.count)*parseFloat(p.amount)); });
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(document.getElementById('expensesChart'), { type: 'bar', data: { labels: Object.keys(cats), datasets: [{ label: 'المصروفات', data: Object.values(cats), backgroundColor: '#6A1B9A' }] }, options: { maintainAspectRatio: false } });
            const salList = document.getElementById('rep-salary-list'); salList.innerHTML = '';
            const salGroups = {}; appData.budget.salaries.filter(s=>checkDate(s.date)).forEach(s => salGroups[s.status] = (salGroups[s.status]||0) + parseFloat(s.amount));
            for(let k in salGroups) { salList.innerHTML += `<li class="list-group-item d-flex justify-content-between"><span>${k==='Paid'?'مدفوع':'غير مدفوع'}</span><span>${formatMoney(salGroups[k])}</span></li>`; }
        }

        function renderAllTables() {
            const chk = checkDate;
            const itb = document.getElementById('invoices-tbody'); itb.innerHTML = ''; appData.budget.invoices.forEach((i, idx) => { if(chk(i.date)) itb.innerHTML += `<tr><td>${i.date}</td><td>${i.customer}</td><td>${i.productName}</td><td>${formatMoney(i.total)}</td><td><span class="status-badge ${i.status==='Paid'?'status-active':'status-inactive'}">${i.status==='Paid'?'مدفوع':'غير مدفوع'}</span></td><td><button class="btn btn-secondary-modern btn-sm" onclick="previewItem('invoice', ${idx})"><i class="bi bi-eye"></i></button> <button class="btn btn-primary-modern btn-sm" onclick="openInvoiceModal(${idx})"><i class="bi bi-pencil"></i></button> <button class="btn btn-danger-modern btn-sm" onclick="delItem('invoices',${idx})"><i class="bi bi-trash"></i></button></td></tr>`; });
            const ptb = document.getElementById('production-tbody'); ptb.innerHTML = ''; appData.budget.productions.forEach((p, idx) => { if(chk(p.date)) { const rowKiloCost = parseFloat(p.boxValue) * 2; ptb.innerHTML += `<tr><td>${p.date}</td><td>${p.name}</td><td>${formatCount(p.boxCount)}</td><td>${formatMoney(p.totalCost)}</td><td>${formatMoney(rowKiloCost)}</td><td><button class="btn btn-secondary-modern btn-sm" onclick="previewItem('production', ${idx})"><i class="bi bi-eye"></i></button> <button class="btn btn-primary-modern btn-sm" onclick="openProductionModal(${idx})"><i class="bi bi-pencil"></i></button> <button class="btn btn-danger-modern btn-sm" onclick="delItem('productions',${idx})"><i class="bi bi-trash"></i></button></td></tr>`; } });
            const putb = document.getElementById('purchases-tbody'); putb.innerHTML = ''; appData.budget.purchases.forEach((p, idx) => { if(chk(p.date)) putb.innerHTML += `<tr><td>${p.date}</td><td>${p.item}</td><td>${formatCount(p.count)}</td><td>${formatMoney(p.amount)}</td><td>${formatMoney(p.count*p.amount)}</td><td>${p.category}</td><td><button class="btn btn-secondary-modern btn-sm" onclick="previewItem('purchase', ${idx})"><i class="bi bi-eye"></i></button> <button class="btn btn-primary-modern btn-sm" onclick="openPurchaseModal(${idx})"><i class="bi bi-pencil"></i></button> <button class="btn btn-danger-modern btn-sm" onclick="delItem('purchases',${idx})"><i class="bi bi-trash"></i></button></td></tr>`; });
            const stb = document.getElementById('salaries-tbody'); stb.innerHTML = ''; appData.budget.salaries.forEach((s, idx) => { if(chk(s.date)) stb.innerHTML += `<tr><td>${s.date}</td><td>${s.category}</td><td>${formatMoney(s.amount)}</td><td>${s.status==='Paid'?'مدفوع':'غير مدفوع'}</td><td>${s.paymentDate||'-'}</td><td><button class="btn btn-secondary-modern btn-sm" onclick="previewItem('salary', ${idx})"><i class="bi bi-eye"></i></button> <button class="btn btn-primary-modern btn-sm" onclick="openSalaryModal(${idx})"><i class="bi bi-pencil"></i></button> <button class="btn btn-danger-modern btn-sm" onclick="delItem('salaries',${idx})"><i class="bi bi-trash"></i></button></td></tr>`; });
            const ttb = document.getElementById('transactions-tbody'); ttb.innerHTML = ''; appData.budget.transactions.forEach((t, idx) => { if(chk(t.date)) ttb.innerHTML += `<tr><td>${t.date}</td><td><span class="status-badge ${t.type==='in'?'status-active':'status-inactive'}">${t.type==='in'?'استلام':'استرداد'}</span></td><td>${formatMoney(t.amount)}</td><td>${t.method}</td><td>${t.notes}</td><td><button class="btn btn-secondary-modern btn-sm" onclick="previewItem('transaction', ${idx})"><i class="bi bi-eye"></i></button> <button class="btn btn-primary-modern btn-sm" onclick="openTransactionModal('${t.type}', ${idx})"><i class="bi bi-pencil"></i></button> <button class="btn btn-danger-modern btn-sm" onclick="delItem('transactions',${idx})"><i class="bi bi-trash"></i></button></td></tr>`; });
        }
        
        function delItem(type, i) { 
            if(confirm('حذف؟')) { 
                if (type === 'productions') {
                    const prod = appData.budget.productions[i];
                    if (prod.usedIngredients) {
                        prod.usedIngredients.forEach(item => {
                            if (appData.budget.purchases[item.id]) {
                                appData.budget.purchases[item.id].remaining = (parseFloat(appData.budget.purchases[item.id].remaining) || 0) + parseFloat(item.qty);
                            }
                        });
                    }
                    if (prod.usedOps) {
                        prod.usedOps.forEach(item => {
                            if (appData.budget.salaries[item.id]) {
                                appData.budget.salaries[item.id].isUsedInProduction = false;
                            }
                        });
                    }
                }
                appData.budget[type].splice(i,1); 
                saveData(); 
                updateBudgetUI(); 
            } 
        }

        // --- Modals Handlers ---
        window.addProdIng = function() {
             const tb = document.getElementById('prod-ing-table').tBodies[0];
             let opts = '<option value="">اختر المنتج...</option>';
             appData.budget.purchases.forEach((p,i) => { 
                 if((p.category=='مواد أولية'||p.category=='تغليف') && p.remaining > 0) {
                     opts += `<option value="${i}" data-price="${p.amount}">${p.item} (متاح: ${p.remaining})</option>`; 
                 }
             });
             tb.insertAdjacentHTML('beforeend', `<tr><td><select class="form-select-modern" onchange="calcProdRow(this)">${opts}</select></td><td><input type="number" class="form-control-modern" oninput="calcProdRow(this)"></td><td class="cost">0.000</td><td><button class="btn btn-danger-modern btn-sm" onclick="this.closest('tr').remove();calcProdTotal()">x</button></td></tr>`);
        };
        window.addProdOp = function() {
             const tb = document.getElementById('prod-op-table').tBodies[0];
             let opts = '<option value="">اختر...</option>';
             appData.budget.salaries.forEach((s,i) => {
                 if(!s.isUsedInProduction) {
                    opts += `<option value="${i}" data-amt="${s.amount}">${s.category} - ${s.date}</option>`;
                 }
             });
             tb.insertAdjacentHTML('beforeend', `<tr><td><select class="form-select-modern" onchange="calcOpRow(this)">${opts}</select></td><td class="amt">0.000</td><td><button class="btn btn-danger-modern btn-sm" onclick="this.closest('tr').remove();calcProdTotal()">x</button></td></tr>`);
        };
        window.calcProdRow = function(e) {
            const r = e.closest('tr'); const s = r.querySelector('select');
            const price = parseFloat(s.options[s.selectedIndex].dataset.price||0);
            const qty = parseFloat(r.querySelector('input').value)||0;
            r.querySelector('.cost').innerText = (price*qty).toFixed(3); calcProdTotal();
        };
        window.calcOpRow = function(e) {
            const r = e.closest('tr'); const s = r.querySelector('select');
            r.querySelector('.amt').innerText = parseFloat(s.options[s.selectedIndex].dataset.amt||0).toFixed(3); calcProdTotal();
        };
        window.calcProdTotal = function() {
            let total = 0;
            document.querySelectorAll('#prod-ing-table .cost').forEach(c => total += parseFloat(c.innerText));
            document.querySelectorAll('#prod-op-table .amt').forEach(c => total += parseFloat(c.innerText));
            const count = parseFloat(document.getElementById('prod-count').value)||1;
            document.getElementById('prod-total').value = total.toFixed(3);
            document.getElementById('prod-unit').value = (total/count).toFixed(3);
        }
        document.getElementById('prod-count').addEventListener('input', calcProdTotal);

        function openProductionModal(i){ 
            const sel=document.getElementById('prod-name'); sel.innerHTML='<option value="">اختر الصنف</option>'; appData.products.filter(p=>p.active).forEach(p=>sel.innerHTML+=`<option>${p.name}</option>`); 
            document.getElementById('prod-ing-table').tBodies[0].innerHTML=''; document.getElementById('prod-op-table').tBodies[0].innerHTML=''; document.getElementById('prod-total').value=''; document.getElementById('prod-unit').value='';
            if(i!==undefined){ 
                const p = appData.budget.productions[i]; document.getElementById('prod-id').value=i; document.getElementById('prod-date').value=p.date; document.getElementById('prod-name').value=p.name; document.getElementById('prod-count').value=p.boxCount; document.getElementById('prod-weight').value=p.weight||'';
            } else { document.getElementById('prod-id').value=''; document.getElementById('prod-date').valueAsDate=new Date(); document.getElementById('prod-count').value=''; }
            new bootstrap.Modal(document.getElementById('productionModal')).show(); 
        }

        function openPurchaseModal(i){ 
            const sel=document.getElementById('pur-cat'); sel.innerHTML=''; categoriesList.forEach(c=>sel.innerHTML+=`<option>${c}</option>`);
            if(i!==undefined){
                const p = appData.budget.purchases[i]; document.getElementById('pur-id').value=i; document.getElementById('pur-date').value=p.date; document.getElementById('pur-item').value=p.item; document.getElementById('pur-count').value=p.count; document.getElementById('pur-amount').value=p.amount; document.getElementById('pur-cat').value=p.category;
                document.getElementById('pur-status').value=p.status||'Unpaid'; document.getElementById('pur-method').value=p.method||'Cash'; document.getElementById('pur-pay-date').value=p.paymentDate||'';
            } else { 
                document.getElementById('pur-id').value=''; document.getElementById('pur-date').valueAsDate=new Date(); 
                document.getElementById('pur-item').value=''; document.getElementById('pur-count').value=''; document.getElementById('pur-amount').value='';
                document.getElementById('pur-status').value='Unpaid'; document.getElementById('pur-pay-date').value='';
            }
            togglePurMethod();
            new bootstrap.Modal(document.getElementById('purchaseModal')).show(); 
        }
        function togglePurMethod() { const isPaid = document.getElementById('pur-status').value === 'Paid'; document.getElementById('pur-method-div').style.display = isPaid ? 'block' : 'none'; }

        function openSalaryModal(i){ 
            if(i!==undefined){
                const s = appData.budget.salaries[i]; document.getElementById('sal-id').value=i; document.getElementById('sal-date').value=s.date; document.getElementById('sal-cat').value=s.category; document.getElementById('sal-amount').value=s.amount; document.getElementById('sal-status').value=s.status; document.getElementById('sal-method').value=s.method||'Cash'; document.getElementById('sal-pay-date').value=s.paymentDate||''; document.getElementById('sal-notes').value=s.notes||''; 
            } else { 
                document.getElementById('sal-id').value=''; document.getElementById('sal-date').valueAsDate=new Date(); 
                document.getElementById('sal-amount').value=''; document.getElementById('sal-status').value='Unpaid'; document.getElementById('sal-notes').value=''; document.getElementById('sal-pay-date').value='';
            }
            toggleSalMethod();
            new bootstrap.Modal(document.getElementById('salaryModal')).show(); 
        }
        function toggleSalMethod() { const isPaid = document.getElementById('sal-status').value === 'Paid'; document.getElementById('sal-pay-div').classList.toggle('d-none', !isPaid); }

        function openInvoiceModal(i){ 
            const sel=document.getElementById('inv-product'); sel.innerHTML='<option value="">اختر المنتج</option>'; appData.products.filter(p=>p.active).forEach((p,idx)=>sel.innerHTML+=`<option value="${idx}" data-price="${parseFloat(p.finalPrice)}">${p.name}</option>`); 
            if(i!==undefined){
                 const inv = appData.budget.invoices[i]; document.getElementById('inv-id').value=i; document.getElementById('inv-date').value=inv.date; document.getElementById('inv-customer').value=inv.customer; document.getElementById('inv-phone').value=inv.phone; document.getElementById('inv-qty').value=inv.qty; document.getElementById('inv-total').value=inv.total; document.getElementById('inv-status').value=inv.status; toggleInvMethod();
            } else { document.getElementById('inv-id').value=''; document.getElementById('inv-date').valueAsDate=new Date(); }
            new bootstrap.Modal(document.getElementById('invoiceModal')).show(); 
        }
        function openTransactionModal(t, i){ 
            document.getElementById('trans-type').value=t; 
            if(i!==undefined){
                 const tr = appData.budget.transactions[i]; document.getElementById('trans-id').value=i; document.getElementById('trans-date').value=tr.date; document.getElementById('trans-amount').value=tr.amount; document.getElementById('trans-method').value=tr.method; document.getElementById('trans-notes').value=tr.notes;
            } else { document.getElementById('trans-id').value=''; document.getElementById('trans-date').valueAsDate=new Date(); document.getElementById('trans-amount').value=''; }
            new bootstrap.Modal(document.getElementById('transModal')).show(); 
        }
        
        function calcInvTotal() { const s = document.getElementById('inv-product'); const price = s.selectedIndex>0 ? parseFloat(s.options[s.selectedIndex].dataset.price) : 0; document.getElementById('inv-total').value = (price * (parseFloat(document.getElementById('inv-qty').value)||0)).toFixed(3); }
        function toggleInvMethod() { document.getElementById('inv-method-div').style.display = document.getElementById('inv-status').value==='Paid'?'block':'none'; }
        
        function saveProduction() { 
            const id = document.getElementById('prod-id').value; 
            if (id && appData.budget.productions[id]) {
                const oldProd = appData.budget.productions[id];
                if (oldProd.usedIngredients) {
                    oldProd.usedIngredients.forEach(item => {
                        if (appData.budget.purchases[item.id]) {
                            appData.budget.purchases[item.id].remaining += parseFloat(item.qty);
                        }
                    });
                }
                if (oldProd.usedOps) {
                    oldProd.usedOps.forEach(item => {
                        if (appData.budget.salaries[item.id]) {
                            appData.budget.salaries[item.id].isUsedInProduction = false;
                        }
                    });
                }
            }

            let usedIngredients = [];
            let usedOps = [];

            const ingRows = document.querySelectorAll('#prod-ing-table tbody tr');
            ingRows.forEach(row => {
                const select = row.querySelector('select');
                const usedQty = parseFloat(row.querySelector('input').value) || 0;
                const idx = select.value;
                if(idx !== "") {
                    if(appData.budget.purchases[idx]) {
                         appData.budget.purchases[idx].remaining -= usedQty;
                         if(appData.budget.purchases[idx].remaining < 0) appData.budget.purchases[idx].remaining = 0;
                         usedIngredients.push({ id: idx, qty: usedQty });
                    }
                }
            });

            const opRows = document.querySelectorAll('#prod-op-table tbody tr');
            opRows.forEach(row => {
                 const select = row.querySelector('select');
                 const idx = select.value;
                 if(idx !== "") {
                     if(appData.budget.salaries[idx]) {
                         appData.budget.salaries[idx].isUsedInProduction = true;
                         usedOps.push({ id: idx });
                     }
                 }
            });

            const data = { date: document.getElementById('prod-date').value, name: document.getElementById('prod-name').value, boxCount: document.getElementById('prod-count').value, totalCost: document.getElementById('prod-total').value, boxValue: document.getElementById('prod-unit').value, weight: document.getElementById('prod-weight').value, usedIngredients: usedIngredients, usedOps: usedOps };
            
            if(id) appData.budget.productions[id] = data; else appData.budget.productions.push(data);
            saveData(); updateBudgetUI(); bootstrap.Modal.getInstance(document.getElementById('productionModal')).hide(); 
        }
        function savePurchase() { 
             const id = document.getElementById('pur-id').value; const isPaid = document.getElementById('pur-status').value === 'Paid';
             const data = { date: document.getElementById('pur-date').value, item: document.getElementById('pur-item').value, count: document.getElementById('pur-count').value, amount: document.getElementById('pur-amount').value, category: document.getElementById('pur-cat').value, status: document.getElementById('pur-status').value, method: isPaid ? document.getElementById('pur-method').value : '-', paymentDate: isPaid ? document.getElementById('pur-pay-date').value : '-', remaining: document.getElementById('pur-count').value };
             if(id) { 
                 data.remaining = appData.budget.purchases[id].remaining; 
                 appData.budget.purchases[id] = data; 
             } else {
                 appData.budget.purchases.push(data);
             }
             saveData(); updateBudgetUI(); bootstrap.Modal.getInstance(document.getElementById('purchaseModal')).hide(); 
        }
        function saveSalary() { 
            const id = document.getElementById('sal-id').value; const isPaid = document.getElementById('sal-status').value === 'Paid';
            const data = { date: document.getElementById('sal-date').value, category: document.getElementById('sal-cat').value, amount: document.getElementById('sal-amount').value, status: document.getElementById('sal-status').value, method: isPaid ? document.getElementById('sal-method').value : '-', paymentDate: isPaid ? document.getElementById('sal-pay-date').value : '-', notes: document.getElementById('sal-notes').value, isUsedInProduction: false };
            if(id) {
                data.isUsedInProduction = appData.budget.salaries[id].isUsedInProduction;
                appData.budget.salaries[id] = data; 
            } else {
                appData.budget.salaries.push(data);
            }
            saveData(); updateBudgetUI(); bootstrap.Modal.getInstance(document.getElementById('salaryModal')).hide(); 
        }
        function saveInvoice() { 
            const s=document.getElementById('inv-product'); const id = document.getElementById('inv-id').value; const data = { date: document.getElementById('inv-date').value, customer: document.getElementById('inv-customer').value, phone: document.getElementById('inv-phone').value, productName: s.options[s.selectedIndex].text, total: document.getElementById('inv-total').value, status: document.getElementById('inv-status').value, qty: document.getElementById('inv-qty').value, method: document.getElementById('inv-method').value };
            if(id) appData.budget.invoices[id] = data; else appData.budget.invoices.push(data);
            saveData(); updateBudgetUI(); bootstrap.Modal.getInstance(document.getElementById('invoiceModal')).hide(); 
        }
        function saveTransaction() { 
            const id = document.getElementById('trans-id').value; const data = { type: document.getElementById('trans-type').value, date: document.getElementById('trans-date').value, amount: document.getElementById('trans-amount').value, method: document.getElementById('trans-method').value, notes: document.getElementById('trans-notes').value };
            if(id) appData.budget.transactions[id] = data; else appData.budget.transactions.push(data);
            saveData(); updateBudgetUI(); bootstrap.Modal.getInstance(document.getElementById('transModal')).hide(); 
        }

        loadData(); initRouting(); calcProduct(); 
        populateFilter('budget-month-filter'); populateFilter('ops-month-filter'); 
        document.getElementById('product-code').value="PRD-"+String(productCounter).padStart(4,'0');
    </script>
</body>
</html>
