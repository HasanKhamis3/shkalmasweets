<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>شكلمة - Shkalma Sweets</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            /* Purple Theme - Shkalma */
            --primary-color: #6A1B9A; 
            --primary-light: #4A148C;
            --secondary-color: #9C27B0;
            --accent-color: #AB47BC;
            --background: #FEFCFF;
            --surface: #ffffff;
            --text-primary: #333;
            --text-secondary: #666;
            --border-color: #E1BEE7;
            --success: #2e7d32;
            --warning: #f9a825;
            --error: #c62828;
            --blue-cost: #1565c0;
            --shadow-sm: 0 4px 12px rgba(106, 27, 154, 0.08);
            --gap-size: 1.5rem;
        }
        * { box-sizing: border-box; }
        body { font-family: 'IBM Plex Sans Arabic', sans-serif; background-color: var(--background); color: var(--text-primary); line-height: 1.6; margin: 0; padding: 0; }
        
        /* Sidebar */
        .sidebar { background: linear-gradient(180deg, var(--primary-color) 0%, var(--primary-light) 100%); min-height: 100vh; color: white; position: fixed; top: 0; right: 0; width: 260px; z-index: 1000; overflow-y: auto; transition: transform 0.3s ease; box-shadow: -4px 0 15px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        .sidebar-header { padding: 2rem 1rem; text-align: center; background: rgba(0,0,0,0.1); }
        .sidebar-logo-img { max-width: 130px; margin-bottom: 10px; filter: brightness(0) invert(1); }
        .sidebar-title { font-size: 1.4rem; font-weight: 700; color: #fff; line-height: 1.2; }
        .sidebar-subtitle { font-size: 0.9rem; font-weight: 300; opacity: 0.9; letter-spacing: 1px; margin-top: 5px; }
        .sidebar-nav { flex-grow: 1; }
        .sidebar .nav-link { color: rgba(255,255,255,0.85); padding: 0.9rem 1.2rem; margin: 0.4rem 0.8rem; border-radius: 12px; display: flex; align-items: center; gap: 0.8rem; font-weight: 500; text-decoration: none; cursor: pointer; transition: 0.2s; }
        .sidebar .nav-link:hover, .sidebar .nav-link.active { background: rgba(255,255,255,0.15); color: #fff; transform: translateX(-5px); backdrop-filter: blur(5px); }
        .sidebar-footer-logo { padding: 30px 20px; text-align: center; margin-top: auto; }
        .sidebar-footer-logo img { max-width: 100px; opacity: 0.95; filter: brightness(0) invert(1); }

        /* Main Content */
        .main-content { margin-right: 260px; padding: 2rem; min-height: 100vh; }
        .page { display: none; animation: fadeIn 0.4s ease; } .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Grid Layout */
        .budget-grid-layout { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: var(--gap-size); align-items: start; }
        .area-treasury { grid-column: 1; } .area-expenses { grid-column: 2; } .area-prod { grid-column: 3; grid-row: 1 / span 2; height: 100%; }
        .area-chart { grid-column: 1; } .area-salaries { grid-column: 2; }

        /* Cards */
        .card-modern { background: var(--surface); border: 1px solid var(--border-color); border-radius: 16px; box-shadow: var(--shadow-sm); overflow: hidden; display: flex; flex-direction: column; height: 100%; margin-bottom: 0; }
        #calculate-product .card-modern, #product-main .card-modern, #invoices-main .card-modern { margin-bottom: var(--gap-size); }
        .card-header-modern { background: #fff; padding: 1.2rem 1.5rem; font-weight: 700; font-size: 1.05rem; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; color: var(--primary-color); }
        .card-body-modern { padding: 1.5rem; flex-grow: 1; }

        .card-dark-container { border: 1px solid #ddd; border-radius: 12px; overflow: hidden; margin-bottom: 1.5rem; background: #fff; box-shadow: var(--shadow-sm); }
        .card-header-dark { background: #2c2c2c; color: #fff; padding: 1rem 1.5rem; font-weight: 700; display: flex; justify-content: space-between; align-items: center; }

        .card-theme-container { border: 2px solid var(--border-color); border-radius: 16px; overflow: hidden; margin-bottom: 1.5rem; background: #F3E5F5; box-shadow: var(--shadow-sm); }
        .card-header-theme { background: #2c2c2c; color: #fff; padding: 1rem 1.5rem; font-weight: 700; display: flex; justify-content: space-between; align-items: center; }
        .card-theme-container .form-control-modern { background: #ffffff; }

        .form-control-modern, .form-select-modern { border: 1px solid #CE93D8; border-radius: 10px; padding: 0.7rem 1rem; width: 100%; }
        .form-control-modern:focus, .form-select-modern:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 3px rgba(106, 27, 154, 0.1); }
        .btn-modern { border: none; border-radius: 10px; padding: 0.6rem 1.2rem; font-weight: 500; cursor: pointer; transition: 0.2s; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .btn-primary-modern { background: var(--primary-color); color: white; }
        .btn-success-modern { background: var(--success); color: white; }
        .btn-danger-modern { background: var(--error); color: white; }
        .btn-warning-modern { background: var(--warning); color: #fff; }
        .btn-info-modern { background: #0288d1; color: white; }

        .table-modern { width: 100%; border-collapse: separate; border-spacing: 0; }
        .table-modern th { background: #F3E5F5; padding: 1rem; text-align: center; font-weight: 600; color: var(--primary-color); border-bottom: 2px solid var(--border-color); }
        .table-modern td { padding: 0.9rem; text-align: center; border-bottom: 1px solid #f0f0f0; vertical-align: middle; }

        .profit-highlight { background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%); color: white; padding: 1.5rem; border-radius: 16px; text-align: center; margin-bottom: 1.5rem; box-shadow: 0 4px 15px rgba(106, 27, 154, 0.2); }
        .profit-highlight h5, .profit-highlight small, .profit-highlight h2 { color: #ffffff !important; opacity: 1 !important; }

        .report-row { display: flex; justify-content: space-between; margin-bottom: 0.8rem; font-size: 0.95rem; } .report-val { font-weight: 700; }
        .prod-item { border-bottom: 1px solid #f0f0f0; padding-bottom: 1rem; margin-bottom: 1rem; } .prod-item:last-child { border: none; margin: 0; padding: 0; }
        .prod-item-name { font-weight: bold; color: var(--primary-color); margin-bottom: 0.5rem; display: block; }
        .prod-item-stat { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 0.2rem; } .prod-item-val { font-weight: 700; color: #333; }
        
        .cost-summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .cost-card { background: white; border: 1px solid var(--border-color); border-radius: 12px; padding: 1.2rem; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .cost-card-title { font-size: 0.85rem; color: #777; margin-bottom: 0.5rem; font-weight: 500; }
        .cost-card-value { font-size: 1.3rem; font-weight: 700; color: var(--primary-color); }
        .cost-card.profit { border-color: var(--warning); } .cost-card.profit .cost-card-value { color: var(--warning); }
        .cost-card.final { border-color: var(--success); background: #e8f5e9; } .cost-card.final .cost-card-value { color: var(--success); }

        .nav-tabs-modern { border: none; gap: 8px; margin-bottom: 1.5rem; }
        .nav-tabs-modern .nav-link { border: 1px solid var(--border-color); border-radius: 20px; color: var(--text-secondary); padding: 0.6rem 1.5rem; font-weight: 500; background: white; }
        .nav-tabs-modern .nav-link.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }

        .price-input-container { position: relative; }
        .price-input-container::after { content: "د.ب"; position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #999; font-size: 0.8rem; }
        .price-input-container input { padding-left: 35px; }
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
        .status-active { background: #e8f5e9; color: #2e7d32; } .status-inactive { background: #ffebee; color: #c62828; }
        .filter-wrapper { background: white; padding: 10px; border-radius: 12px; box-shadow: var(--shadow-sm); border: 1px solid var(--border-color); margin-bottom: 20px; }

        .summary-input-large { font-size: 1.5rem; font-weight: 700; text-align: center; height: 60px; background: #fff; color: #333; border: 1px solid #ddd; }
        .summary-label { font-size: 0.9rem; color: var(--primary-color); margin-bottom: 8px; font-weight: 700; display: block; text-align: center; }
        .profit-btn-display { border-radius: 8px; padding: 8px; font-weight: 600; font-size: 0.9rem; text-align: center; margin-top: 10px; border: 1px solid transparent; }
        .profit-btn-green { background: #e8f5e9; color: #2e7d32; border-color: #2e7d32; }
        .profit-btn-orange { background: #fff3e0; color: #ef6c00; border-color: #ef6c00; }
        .depreciation-note { background: #ffebee; color: #c62828; border: 1px solid #ef9a9a; border-radius: 8px; padding: 10px; text-align: center; font-weight: 600; font-size: 0.9rem; margin-top: 15px; }
        .text-blue-custom { color: #1976d2; font-weight: 700; } .text-orange-custom { color: #f57c00; font-weight: 700; }
        .save-btn-container { text-align: center; margin-top: 20px; }
        .save-btn-custom { background: #00c853; color: white; font-size: 1.1rem; padding: 10px 40px; border-radius: 8px; border: none; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; }
        .save-btn-custom:hover { background: #009624; color: white; }

        @media (max-width: 992px) {
            .budget-grid-layout { grid-template-columns: 1fr; }
            .area-treasury, .area-expenses, .area-chart, .area-salaries, .area-prod { grid-column: auto; grid-row: auto; }
            .sidebar { transform: translateX(100%); } .main-content { margin-right: 0; padding: 1rem; }
        }
    </style>
</head>
<body>
    <button class="btn btn-primary-modern d-md-none position-fixed" style="top:1rem;right:1rem;z-index:1001" id="sidebarToggle"><i class="bi bi-list"></i></button>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="https://i.imgur.com/image_f84c5f.png" alt="Shkalma" class="sidebar-logo-img" onerror="this.style.display='none'">
            <div class="sidebar-title">شكلمة</div>
            <div class="sidebar-subtitle">Shkalma Sweets</div>
        </div>
        <nav class="sidebar-nav">
            <ul class="nav flex-column">
                <li class="nav-item"><a class="nav-link active" href="#dashboard" data-page="dashboard"><i class="bi bi-pie-chart-fill"></i> ملخص الميزانية</a></li>
                <li class="nav-item"><a class="nav-link" href="#product-main" data-page="product-main"><i class="bi bi-box-seam-fill"></i> المنتجات</a></li>
                <li class="nav-item"><a class="nav-link" href="#invoices-main" data-page="invoices-main"><i class="bi bi-receipt"></i> الفواتير</a></li>
                <li class="nav-item"><a class="nav-link" href="#budget-ops" data-page="budget-ops"><i class="bi bi-wallet2"></i> العمليات المالية</a></li>
            </ul>
        </nav>
        <div class="sidebar-footer-logo">
            <img src="https://i.imgur.com/image_f84c5f.png" alt="Logo">
        </div>
    </div>

    <div class="main-content">
        <div id="dashboard" class="page active">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="fw-bold text-primary m-0"><i class="bi bi-speedometer2"></i> ملخص الميزانية</h3>
            </div>
            <div class="filter-wrapper"><div class="row align-items-center g-2"><div class="col-auto"><i class="bi bi-filter text-primary fs-5"></i></div><div class="col-md-4"><select id="budget-month-filter" class="form-select-modern" onchange="toggleFilterInputs('budget')"></select></div><div class="col-md-7" id="budget-filter-custom-div" style="display:none;"><div class="d-flex gap-2 align-items-center"><input type="date" id="budget-filter-from" class="form-control-modern" placeholder="من"><input type="date" id="budget-filter-to" class="form-control-modern" placeholder="إلى"><button class="btn btn-primary-modern btn-sm" onclick="updateBudgetUI()">تطبيق</button></div></div></div></div>
            <div class="row mb-4 g-3">
                <div class="col-md-6"><div class="profit-highlight h-100 d-flex flex-column justify-content-center"><h5 class="mb-2">صافي الربح من المبيعات</h5><h2 class="fw-bold m-0" id="report-net-benefit">0.000 د.ب</h2><small>المبيعات - تكلفة البضاعة المباعة</small></div></div>
                <div class="col-md-6"><div class="profit-highlight h-100 d-flex flex-column justify-content-center" style="background: linear-gradient(135deg, var(--secondary-color), var(--primary-light));"><h5 class="mb-2">صافي الربح بناءً على الميزانية</h5><h2 class="fw-bold m-0" id="report-net-budget">0.000 د.ب</h2><small>إجمالي المبيعات - إجمالي المصروفات</small></div></div>
            </div>
            <div class="budget-grid-layout">
                <div class="card-modern area-treasury" style="border-top: 4px solid var(--success);"><div class="card-header-modern text-success"><i class="bi bi-bank"></i> الخزينة</div><div class="card-body-modern"><div class="report-row"><span>استلام (كاش)</span><span class="report-val text-success" id="rep-cash-in">0.000</span></div><div class="report-row"><span>استلام (بنفت)</span><span class="report-val text-success" id="rep-benefit-in">0.000</span></div><hr class="my-2"><div class="report-row"><span>استرداد (كاش)</span><span class="report-val text-danger" id="rep-cash-out">0.000</span></div><div class="report-row"><span>استرداد (بنفت)</span><span class="report-val text-danger" id="rep-benefit-out">0.000</span></div><hr class="my-2"><div class="report-row fw-bold text-primary"><span>المجموع</span><span class="report-val" id="rep-net">0.000</span></div><div class="report-row fw-bold mt-2 pt-2 border-top"><span>المتبقي</span><div class="text-end"><div class="small">كاش: <span id="rem-cash">0.000</span></div><div class="small">بنفت: <span id="rem-benefit">0.000</span></div><div class="text-success" id="rep-final-remainder">الإجمالي: 0.000</div></div></div></div></div>
                <div class="card-modern area-expenses" style="border-top: 4px solid var(--error);"><div class="card-header-modern text-danger"><i class="bi bi-cart-dash"></i> المصروفات</div><div class="card-body-modern"><div class="report-row"><span>المشتريات</span><span class="report-val" id="rep-purchases-total">0.000</span></div><div class="report-row"><span>الرواتب</span><span class="report-val" id="rep-salaries-total">0.000</span></div><hr class="my-2"><div class="report-row fw-bold text-danger"><span>الإجمالي</span><span class="report-val" id="rep-expenses-total">0.000</span></div></div></div>
                <div class="card-modern area-prod" style="border-top: 4px solid var(--warning);"><div class="card-header-modern text-warning"><i class="bi bi-box-seam"></i> الإنتاج</div><div class="card-body-modern"><div id="production-list-container"></div><small class="text-muted d-block mt-3 text-center pt-2 border-top">* الكيلو = 2 علبة</small></div></div>
                <div class="card-modern area-chart"><div class="card-header-modern">تحليل المصروفات</div><div class="card-body-modern d-flex justify-content-center align-items-center"><div style="height: 350px; width: 100%;"><canvas id="expensesChart"></canvas></div></div></div>
                <div class="card-modern area-salaries"><div class="card-header-modern">تفاصيل الرواتب</div><ul class="list-group list-group-flush" id="rep-salary-list"></ul></div>
            </div>
        </div>

        <div id="product-main" class="page">
            <h3 class="mb-4 fw-bold text-primary">المنتجات</h3>
            <ul class="nav nav-pills nav-tabs-modern" id="productTabs">
                <li class="nav-item"><button class="nav-link active" onclick="switchProductView('list')"><i class="bi bi-list-ul"></i> قائمة المنتجات</button></li>
                <li class="nav-item"><button class="nav-link" onclick="switchProductView('calc'); clearForm();"><i class="bi bi-calculator"></i> حساب تكلفة منتج جديد</button></li>
            </ul>
            <div id="view-product-list"><div class="card-modern"><div class="card-body-modern p-0"><div class="table-responsive"><table class="table-modern" id="products-list-table"><thead><tr><th>الرمز</th><th>الاسم</th><th>التكلفة</th><th>السعر</th><th>الربح</th><th>الحالة</th><th>الإجراءات</th></tr></thead><tbody id="products-list"></tbody></table></div></div></div></div>
            <div id="view-product-calc" style="display:none;">
                <div class="cost-summary-grid">
                    <div class="cost-card"><div class="cost-card-title">مواد</div><div class="cost-card-value" id="summary-materials">0.000</div></div>
                    <div class="cost-card"><div class="cost-card-title">تغليف</div><div class="cost-card-value" id="summary-packaging">0.000</div></div>
                    <div class="cost-card"><div class="cost-card-title">عمالة</div><div class="cost-card-value" id="summary-labor">0.000</div></div>
                    <div class="cost-card"><div class="cost-card-title">إهلاك</div><div class="cost-card-value" id="summary-depreciation">0.000</div></div>
                    <div class="cost-card final"><div class="cost-card-title">بيع</div><div class="cost-card-value" id="summary-sale-price">0.000</div></div>
                    <div class="cost-card profit"><div class="cost-card-title">ربح</div><div class="cost-card-value" id="summary-profit-margin">0.000</div></div>
                </div>
                <div class="card-modern"><div class="card-header-modern">البيانات الأساسية</div><div class="card-body-modern"><div class="row g-3"><div class="col-md-4"><label class="form-label">اسم المنتج</label><input type="text" class="form-control-modern" id="product-name"></div><div class="col-md-3"><label class="form-label">القطع في العلبة</label><input type="number" class="form-control-modern" id="sale-quantity"></div><div class="col-md-2"><label class="form-label">نسبة الربح (%)</label><input type="number" class="form-control-modern" id="profit-rate"></div><div class="col-md-3"><label class="form-label">الرمز</label><input type="text" class="form-control-modern" id="product-code" readonly style="background:#f9f9f9"></div></div></div></div>
                <div class="row">
                    <div class="col-md-12"><div class="card-modern"><div class="card-header-modern">اليد العاملة</div><div class="card-body-modern"><div class="d-flex justify-content-center gap-4 mb-3"><div class="form-check"><input class="form-check-input" type="radio" name="laborMethod" id="laborMethodSalary" value="salary" checked onchange="toggleLaborMethod()"><label class="form-check-label fw-bold" for="laborMethodSalary">راتب شهري</label></div><div class="form-check"><input class="form-check-input" type="radio" name="laborMethod" id="laborMethodWeight" value="weight" onchange="toggleLaborMethod()"><label class="form-check-label fw-bold" for="laborMethodWeight">بالوزن/القطعة</label></div></div><div id="labor-salary-container"><div class="row"><div class="col-md-6"><table class="table-modern"><thead><tr><th>الراتب</th><th>ساعات العمل</th><th>تكلفة الساعة</th></tr></thead><tbody><tr><td><input type="number" class="form-control-modern salary"></td><td><input type="number" class="form-control-modern hours"></td><td class="hourly-cost fw-bold">0.000</td></tr></tbody></table></div><div class="col-md-6"><table class="table-modern"><thead><tr><th>إنتاج (قطع)</th><th>قطع/ساعة</th><th>تكلفة القطعة</th></tr></thead><tbody><tr><td><input type="number" class="form-control-modern pieces"></td><td class="pieces-per-hour fw-bold">0</td><td class="piece-cost fw-bold">0.000</td></tr></tbody></table></div></div></div><div id="labor-weight-container" style="display: none;"><div class="row g-3 justify-content-center"><div class="col-md-4"><label>قيمة الكيلو</label><input type="number" class="form-control-modern" id="labor-weight-price"></div><div class="col-md-4"><label>وزن العلبة (كجم)</label><input type="number" class="form-control-modern" id="labor-weight-box-weight"></div><div class="col-md-4"><label>أخرى</label><input type="number" class="form-control-modern" id="labor-weight-other"></div></div></div></div></div></div>
                    <div class="col-md-6"><div class="card-modern"><div class="card-header-modern">المواد الأولية</div><div class="card-body-modern"><table class="table-modern" id="materials-table"><thead><tr><th width="35%">المادة</th><th>السعر</th><th>العدد/الوزن</th><th>المستخدم</th><th>التكلفة</th><th></th></tr></thead><tbody id="materials-tbody"><tr><td><input class="form-control-modern material-name"></td><td><input type="number" class="form-control-modern material-price" step="0.001"></td><td><input type="number" class="form-control-modern material-count" value="1"></td><td><input type="number" class="form-control-modern material-used"></td><td class="material-cost fw-bold">0.000</td><td><button class="btn btn-danger-modern btn-sm remove-row"><i class="bi bi-trash"></i></button></td></tr></tbody></table><button class="btn btn-success-modern w-100 mt-2" id="add-material"><i class="bi bi-plus"></i> إضافة مادة</button></div></div></div>
                    <div class="col-md-6"><div class="card-modern"><div class="card-header-modern">التغليف</div><div class="card-body-modern"><table class="table-modern" id="packaging-table"><thead><tr><th width="35%">المادة</th><th>السعر</th><th>العدد</th><th>المستخدم</th><th>التكلفة</th><th></th></tr></thead><tbody id="packaging-tbody"><tr><td><input class="form-control-modern packaging-name"></td><td><input type="number" class="form-control-modern packaging-price" step="0.001"></td><td><input type="number" class="form-control-modern packaging-count" value="1"></td><td><input type="number" class="form-control-modern packaging-used"></td><td class="packaging-cost fw-bold">0.000</td><td><button class="btn btn-danger-modern btn-sm remove-row"><i class="bi bi-trash"></i></button></td></tr></tbody></table><button class="btn btn-success-modern w-100 mt-2" id="add-packaging"><i class="bi bi-plus"></i> إضافة تغليف</button></div></div></div>
                </div>
                
                <div class="card-theme-container">
                    <div class="card-header-theme"><i class="bi bi-tools"></i> إهلاك المعدات</div>
                    <div class="p-3">
                        <div class="row g-3"><div class="col-md-4 order-md-1"><label class="summary-label">النسبة المئوية (%)</label><input type="number" class="form-control-modern text-center" id="depreciation-rate" placeholder="أدخل النسبة"></div><div class="col-md-4 order-md-2"><label class="summary-label">إهلاك المعدات (د.ب)</label><input type="text" class="form-control-modern text-center" id="equipment-depreciation" readonly value="0.000"></div><div class="col-md-4 order-md-3"><label class="summary-label">إهلاك المعدات للعلبة (د.ب)</label><input type="text" class="form-control-modern text-center" id="equipment-depreciation-box" readonly value="0.000"></div></div>
                        <div class="depreciation-note">* نسبة الإهلاك هي تقدير لتكلفة استهلاك المعدات والأجهزة المستخدمة في إنتاج المنتج ونقترح أن تكون 10%</div>
                    </div>
                </div>
                
                <div class="card-theme-container">
                    <div class="card-header-theme"><i class="bi bi-currency-dollar"></i> ملخص التكاليف والأسعار</div>
                    <div class="p-4">
                        <div class="row g-4 align-items-center
